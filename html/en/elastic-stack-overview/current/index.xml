<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<?asciidoc-toc?>
<?asciidoc-numbered?>

<book lang="en">
<bookinfo>
    <title>Elastic Stack Overview</title>
</bookinfo>
<chapter id="xpack-introduction">
<title>Introduction<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/xpack-introduction.asciidoc">Edit me</ulink></title>
<simpara>The Elastic Stack enables you to reliably and securely take data from any source in
any format and search, analyze, and visualize it in real time.</simpara>
<simpara>For a quick overview, see: <ulink url="https://www.elastic.co/products">https://www.elastic.co/products</ulink></simpara>
<bridgehead id="_where_to_go_next" renderas="sect2">Where to Go Next<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/xpack-introduction.asciidoc">Edit me</ulink></bridgehead>
<itemizedlist>
<listitem>
<simpara>
<link linkend="get-started-elastic-stack">Getting started with the Elastic Stack</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="security-getting-started">Getting Started with Security</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="xpack-monitoring">Getting Started with Monitoring</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="watcher-getting-started">Getting Started with Alerting and Notification</link>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/kibana/6.3/reporting-getting-started.html">Getting Started with Reporting</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/kibana/6.3/graph-getting-started.html">Getting Started with Graph</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="ml-getting-started">Getting Started with Machine Learning</link>
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_have_comments_questions_or_feedback" renderas="sect2">Have Comments, Questions, or Feedback?<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/xpack-introduction.asciidoc">Edit me</ulink></bridgehead>
<simpara>Head over to our discussion forums to share you experience, questions, and
suggestions:</simpara>
<itemizedlist>
<listitem>
<simpara>
<ulink url="https://discuss.elastic.co/c/x-pack/shield">Security Discussion Forum</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://discuss.elastic.co/c/x-pack/marvel">Monitoring Discussion Forum</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://discuss.elastic.co/c/x-pack/watcher">Alerting &amp; Notification Discussion Forum</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://discuss.elastic.co/c/x-pack/graph">Graph Discussion Forum</ulink>
</simpara>
</listitem>
</itemizedlist>
</chapter>
<chapter id="get-started-elastic-stack">
<title>Getting started with the Elastic Stack<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></title>
<simpara>Looking for an Elastic Stack ("ELK" tutorial) that shows how to set up the Elastic Stack? In
this tutorial, you learn how to get up and running quickly. First you install
the core open source products:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="install-elasticsearch">Elasticsearch</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="install-kibana">Kibana</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="install-beats">Beats</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="install-logstash">Logstash</link>
</simpara>
</listitem>
</itemizedlist>
<simpara>Then you learn how to implement a system monitoring solution that uses
Metricbeat to collect server metrics and ship the data to Elasticsearch, where you can
search and visualize the data by using Kibana. After you get the basic setup
working, you add Logstash for additional parsing.</simpara>
<simpara>To get started, you can install the Elastic Stack on a single VM or even on your
laptop.</simpara>
<important><simpara>Implementing security is a critical step in setting up the Elastic Stack.
To get up and running quickly with a sample installation, you skip those steps
right now. Before sending sensitive data across the network, make sure you
<link linkend="xpack-security">secure the stack</link> and enable
<link linkend="encrypting-communications">encrypted communications</link>.</simpara></important>
<bridgehead id="install-prereqs" renderas="sect2">Before you begin<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<itemizedlist>
<listitem>
<simpara>
See the <ulink url="https://www.elastic.co/support/matrix">Elastic Support
Matrix</ulink> for information about supported operating systems and product
compatibility.
</simpara>
</listitem>
<listitem>
<simpara>
Verify that your system meets the
<ulink url="https://www.elastic.co/support/matrix#matrix_jvm">minimum JVM requirements</ulink> for
Logstash and Elasticsearch.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="install-elasticsearch" renderas="sect2">Install Elasticsearch<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara><ulink url="https://www.elastic.co/products/elasticsearch">Elasticsearch</ulink> is a real-time,
distributed storage, search, and analytics engine. It can be used for many
purposes, but one context where it excels is indexing streams of semi-structured
data, such as logs or decoded network packets.</simpara>
<tip>
<simpara>You can run Elasticsearch on your own hardware, or use our
<ulink url="https://www.elastic.co/cloud/elasticsearch-service">hosted Elasticsearch Service</ulink>
on Elastic Cloud. The Elasticsearch Service is available on both AWS and GCP.
<ulink url="https://www.elastic.co/cloud/elasticsearch-service/signup">Try out the
Elasticsearch Service for free</ulink>.</simpara>
</tip>
<simpara>To download and install Elasticsearch, open a terminal window and use the commands that
work with your system (<link linkend="deb">deb</link> for Debian/Ubuntu, <link linkend="rpm">rpm</link> for
Redhat/Centos/Fedora, <link linkend="mac">mac</link> for OS X, and <link linkend="win">win</link> for Windows):</simpara>
<simpara><anchor id="deb" xreflabel="[deb]"/><emphasis role="strong">deb:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.3.2.deb
sudo dpkg -i elasticsearch-6.3.2.deb
sudo /etc/init.d/elasticsearch start</programlisting>
<simpara><anchor id="rpm" xreflabel="[rpm]"/><emphasis role="strong">rpm:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.3.2.rpm
sudo rpm -i elasticsearch-6.3.2.rpm
sudo service elasticsearch start</programlisting>
<simpara><anchor id="mac" xreflabel="[mac]"/><emphasis role="strong">mac:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.3.2.tar.gz
tar -xzvf elasticsearch-6.3.2.tar.gz
cd elasticsearch-6.3.2
./bin/elasticsearch</programlisting>
<simpara><anchor id="win" xreflabel="[win]"/><emphasis role="strong">win:</emphasis></simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Download the Elasticsearch 6.3.2 Windows zip file from the
<ulink url="https://www.elastic.co/downloads/elasticsearch">Elasticsearch download</ulink> page.
</simpara>
</listitem>
<listitem>
<simpara>
Extract the contents of the zip file to a directory on your computer, for
example, <literal>C:\Program Files</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Open a command prompt as an Administrator and navigate to the directory that
contains the extracted files, for example:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">cd C:\Program Files\elasticsearch-6.3.2</programlisting>
</listitem>
<listitem>
<simpara>
Start Elasticsearch:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">bin\elasticsearch.bat</programlisting>
</listitem>
</orderedlist>
<simpara>For other operating systems, go to the
<ulink url="https://www.elastic.co/downloads/elasticsearch">Elasticsearch download</ulink> page.</simpara>
<simpara>To learn more about installing, configuring, and running Elasticsearch, read the
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">Elasticsearch Reference</ulink>.</simpara>
<bridgehead id="_make_sure_elasticsearch_is_up_and_running" renderas="sect3">Make sure Elasticsearch is up and running<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara>To test that the Elasticsearch daemon is up and running, try sending an HTTP GET
request on port 9200.</simpara>
<programlisting language="shell" linenumbering="unnumbered">curl http://127.0.0.1:9200</programlisting>
<simpara>On Windows, if you don&#8217;t have cURL installed, point your browser to the URL.</simpara>
<simpara>You should see a response similar to this:</simpara>
<programlisting language="sh" linenumbering="unnumbered">{
  "name" : "QtI5dUu",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "DMXhqzzjTGqEtDlkaMOzlA",
  "version" : {
    "number" : "6.3.2",
    "build_flavor" : "default",
    "build_type" : "tar",
    "build_hash" : "00d8bc1",
    "build_date" : "2018-06-06T16:48:02.249996Z",
    "build_snapshot" : false,
    "lucene_version" : "7.3.1",
    "minimum_wire_compatibility_version" : "5.6.0",
    "minimum_index_compatibility_version" : "5.0.0"
  },
  "tagline" : "You Know, for Search"
}</programlisting>
<bridgehead id="install-kibana" renderas="sect2">Install Kibana<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara><ulink url="https://www.elastic.co/products/kibana">Kibana</ulink> is an open source analytics and
visualization platform designed to work with Elasticsearch. You use Kibana to search,
view, and interact with data stored in Elasticsearch indices. You can easily perform
advanced data analysis and visualize your data in a variety of charts, tables,
and maps.</simpara>
<tip>
<simpara>If you are running our hosted Elasticsearch Service on <ulink url="https://www.elastic.co/cloud">Elastic Cloud</ulink>,
then <ulink url="https://www.elastic.co/guide/en/cloud/current/ec-enable-kibana.html">Kibana can be enabled</ulink> with the flick of a switch.</simpara>
</tip>
<simpara>We recommend that you install Kibana on the same server as Elasticsearch,
but it is not required. If you install the products on different servers, you&#8217;ll
need to change the URL (IP:PORT) of the Elasticsearch server in the Kibana configuration
file, <literal>kibana.yml</literal>, before starting Kibana.</simpara>
<simpara>To download and install Kibana, open a terminal window and use the commands that
work with your system:</simpara>
<simpara><emphasis role="strong">deb or rpm:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">curl -L -O https://artifacts.elastic.co/downloads/kibana/kibana-6.3.2-linux-x86_64.tar.gz
tar xzvf kibana-6.3.2-linux-x86_64.tar.gz
cd kibana-6.3.2-linux-x86_64/
./bin/kibana</programlisting>
<simpara><emphasis role="strong">mac:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">curl -L -O https://artifacts.elastic.co/downloads/kibana/kibana-6.3.2-darwin-x86_64.tar.gz
tar xzvf kibana-6.3.2-darwin-x86_64.tar.gz
cd kibana-6.3.2-darwin-x86_64/
./bin/kibana</programlisting>
<simpara><emphasis role="strong">win:</emphasis></simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Download the Kibana 6.3.2 Windows zip file from the
<ulink url="https://www.elastic.co/downloads/kibana">Kibana download</ulink> page.
</simpara>
</listitem>
<listitem>
<simpara>
Extract the contents of the zip file to a directory on your computer, for
example, <literal>C:\Program Files</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Open a command prompt as an Administrator and navigate to the directory that
contains the extracted files, for example:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">cd C:\Program Files\kibana-6.3.2-windows</programlisting>
</listitem>
<listitem>
<simpara>
Start Kibana:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">bin\kibana.bat</programlisting>
</listitem>
</orderedlist>
<simpara>For other operating systems, go to the
<ulink url="https://www.elastic.co/downloads/kibana">Kibana download</ulink> page.</simpara>
<simpara>To learn more about installing, configuring, and running Kibana, read the
<ulink url="https://www.elastic.co/guide/en/kibana/current/index.html">Kibana Reference</ulink>.</simpara>
<bridgehead id="_launch_the_kibana_web_interface" renderas="sect3">Launch the Kibana web interface<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara>To launch the Kibana web interface, point your browser to port 5601. For example,
<ulink url="http://127.0.0.1:5601">http://127.0.0.1:5601</ulink>.</simpara>
<bridgehead id="install-beats" renderas="sect2">Install Beats<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara>The Beats are open source data shippers that you install as agents on your
servers to send operational data to Elasticsearch. Beats can send data directly to Elasticsearch
or via Logstash, where you can further process and enhance the data.</simpara>
<simpara>Each Beat is a separately installable product. In this tutorial, you learn how
to install and run Metricbeat with the <literal>system</literal> module enabled to collect system
metrics.</simpara>
<simpara>To learn more about installing and configuring other Beats, see the Getting
Started documentation:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top">Elastic Beats </entry>
<entry align="left" valign="top"> To capture</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/beats/auditbeat/6.3/auditbeat-getting-started.html">Auditbeat</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>Audit data</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/beats/filebeat/6.3/filebeat-getting-started.html">Filebeat</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>Log files</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/beats/heartbeat/6.3/heartbeat-getting-started.html">Heartbeat</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>Availability monitoring</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/beats/metricbeat/6.3/metricbeat-getting-started.html">Metricbeat</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>Metrics</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/beats/packetbeat/6.3/packetbeat-getting-started.html">Packetbeat</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>Network traffic</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/beats/winlogbeat/6.3/winlogbeat-getting-started.html">Winlogbeat</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>Windows event logs</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<bridgehead id="install-metricbeat" renderas="sect3">Install Metricbeat<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara>To download and install Metricbeat, open a terminal window and use the commands
that work with your system:</simpara>
<simpara><emphasis role="strong">deb:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-6.3.2-amd64.deb
sudo dpkg -i metricbeat-6.3.2-amd64.deb</programlisting>
<simpara><emphasis role="strong">rpm:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-6.3.2-x86_64.rpm
sudo rpm -vi metricbeat-6.3.2-x86_64.rpm</programlisting>
<simpara><emphasis role="strong">mac:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">curl -L -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-6.3.2-darwin-x86_64.tar.gz
tar xzvf metricbeat-6.3.2-darwin-x86_64.tar.gz</programlisting>
<simpara><emphasis role="strong">win:</emphasis></simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Download the Metricbeat Windows zip file from the
<ulink url="https://www.elastic.co/downloads/beats/metricbeat">Metricbeat download</ulink> page.
</simpara>
</listitem>
<listitem>
<simpara>
Extract the contents of the zip file into <literal>C:\Program Files</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Rename the <literal>metricbeat-6.3.2-windows</literal> directory to <literal>Metricbeat</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Open a PowerShell prompt as an Administrator (right-click the PowerShell icon
and select <emphasis role="strong">Run As Administrator</emphasis>).
</simpara>
</listitem>
<listitem>
<simpara>
From the PowerShell prompt, run the following commands to install Metricbeat
as a Windows service:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">PS &gt; cd 'C:\Program Files\Metricbeat'
PS C:\Program Files\Metricbeat&gt; .\install-service-metricbeat.ps1</programlisting>
<note><simpara>If script execution is disabled on your system, set the execution policy
for the current session to allow the script to run. For example: <literal>PowerShell.exe
-ExecutionPolicy UnRestricted -File .\install-service-metricbeat.ps1</literal>.</simpara></note>
</listitem>
</orderedlist>
<simpara>For other operating systems, go to the
<ulink url="https://www.elastic.co/downloads/beats">Beats download</ulink> page.</simpara>
<bridgehead id="ship-system-logs" renderas="sect3">Ship system metrics to Elasticsearch<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara>Metricbeat provides pre-built modules that you can use to rapidly implement
and deploy a system monitoring solution, complete with sample dashboards and
data visualizations, in about 5 minutes.</simpara>
<simpara>In this section, you learn how to run the <literal>system</literal> module to collect metrics
from the operating system and services running on your server. The system module
collects system-level metrics, such as CPU usage, memory, file system, disk IO,
and network IO statistics, as well as top-like statistics for every process
running on your system.</simpara>
<simpara><emphasis role="strong">Before you begin</emphasis>: Verify that Elasticsearch and Kibana are running and that Elasticsearch is
ready to receive data from Metricbeat.</simpara>
<simpara>To set up the <literal>system</literal> module and start collecting system metrics:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
From the Metricbeat install directory, enable the <literal>system</literal> module:
</simpara>
<simpara><emphasis role="strong">deb and rpm:</emphasis></simpara>
<programlisting language="yaml" linenumbering="unnumbered">sudo metricbeat modules enable system</programlisting>
<simpara><emphasis role="strong">mac:</emphasis></simpara>
<programlisting language="yaml" linenumbering="unnumbered">./metricbeat modules enable system</programlisting>
<simpara><emphasis role="strong">win:</emphasis></simpara>
<programlisting language="yaml" linenumbering="unnumbered">PS C:\Program Files\Metricbeat&gt; .\metricbeat.exe modules enable system</programlisting>
</listitem>
<listitem>
<simpara>
Set up the initial environment:
</simpara>
<simpara><emphasis role="strong">deb and rpm:</emphasis></simpara>
<programlisting language="yaml" linenumbering="unnumbered">sudo metricbeat setup -e</programlisting>
<simpara><emphasis role="strong">mac:</emphasis></simpara>
<programlisting language="yaml" linenumbering="unnumbered">./metricbeat setup -e</programlisting>
<simpara><emphasis role="strong">win:</emphasis></simpara>
<programlisting language="yaml" linenumbering="unnumbered">PS C:\Program Files\Metricbeat&gt; metricbeat.exe setup -e</programlisting>
<simpara>The <literal>setup</literal> command loads the Kibana dashboards. If the dashboards are already
set up, omit this command. The <literal>-e</literal> flag is optional and sends output to
standard error instead of syslog.</simpara>
</listitem>
<listitem>
<simpara>
Start Metricbeat:
</simpara>
<simpara id="gs-start-metricbeat"><emphasis role="strong">deb and rpm:</emphasis></simpara>
<programlisting language="yaml" linenumbering="unnumbered">sudo service metricbeat start</programlisting>
<simpara><emphasis role="strong">mac:</emphasis></simpara>
<programlisting language="yaml" linenumbering="unnumbered">./metricbeat -e</programlisting>
<simpara><emphasis role="strong">win:</emphasis></simpara>
<programlisting language="yaml" linenumbering="unnumbered">PS C:\Program Files\Metricbeat&gt; Start-Service metricbeat</programlisting>
</listitem>
</orderedlist>
<simpara>Metricbeat runs and starts sending system metrics to Elasticsearch.</simpara>
<bridgehead id="visualize-system-metrics" renderas="sect3">Visualize system metrics in Kibana<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara>To visualize system metrics, open your browser and navigate to the Metricbeat
system overview dashboard: <ulink url="http://localhost:5601/app/kibana#/dashboard/Metricbeat-system-overview">http://localhost:5601/app/kibana#/dashboard/Metricbeat-system-overview</ulink></simpara>
<tip><simpara>If you don’t see data in Kibana, try changing the date range to a larger
range. By default, Kibana shows the last 15 minutes. If you see errors, make
sure Metricbeat is running, then refresh the page.</simpara></tip>
<informalfigure role="screenshot">
<mediaobject>
  <imageobject>
  <imagedata fileref="images/metricbeat-system-overview.png"/>
  </imageobject>
  <textobject><phrase>Metricbeat system overview</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>Click <emphasis role="strong">Host Overview</emphasis> to see detailed metrics about the selected host.</simpara>
<informalfigure role="screenshot">
<mediaobject>
  <imageobject>
  <imagedata fileref="images/metricbeat-system-host-details.png"/>
  </imageobject>
  <textobject><phrase>Metricbeat host overview</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>Now that you know how to set up the simplest architecture for the Elastic Stack&#8212;one
or more Beats sending event data directly to an Elasticsearch instance running on the
same server&#8212;let&#8217;s add Logstash.</simpara>
<bridgehead id="install-logstash" renderas="sect2">Install Logstash<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara><ulink url="https://www.elastic.co/products/logstash">Logstash</ulink> is a powerful tool that
integrates with a wide variety of deployments. It offers a large selection of
plugins to help you parse, enrich, transform, and buffer data from a variety of
sources.</simpara>
<simpara>To download and install Logstash, open a terminal window and use the commands that
work with your system:</simpara>
<simpara><emphasis role="strong">deb:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">curl -L -O https://artifacts.elastic.co/downloads/logstash/logstash-6.3.2.deb
sudo dpkg -i logstash-6.3.2.deb</programlisting>
<simpara><emphasis role="strong">rpm:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">curl -L -O https://artifacts.elastic.co/downloads/logstash/logstash-6.3.2.rpm
sudo rpm -i logstash-6.3.2.rpm</programlisting>
<simpara><emphasis role="strong">mac:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">curl -L -O https://artifacts.elastic.co/downloads/logstash/logstash-6.3.2.tar.gz
tar -xzvf logstash-6.3.2.tar.gz</programlisting>
<simpara><emphasis role="strong">win:</emphasis></simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Download the Logstash 6.3.2 Windows zip file from the
<ulink url="https://www.elastic.co/downloads/logstash">Logstash download</ulink> page.
</simpara>
</listitem>
<listitem>
<simpara>
Extract the contents of the zip file to a directory on your computer, for
example, <literal>C:\Program Files</literal>. Use a short path (fewer than 30 characters) to
avoid running into file path length limitations on Windows.
</simpara>
</listitem>
</orderedlist>
<simpara>For other operating systems, go to the
<ulink url="https://www.elastic.co/downloads/logstash">Logstash download</ulink> page.</simpara>
<simpara>To learn more about installing, configuring, and running Logstash, read the
<ulink url="http://www.elastic.co/guide/en/logstash/6.3/index.html">Logstash Reference</ulink>.</simpara>
<bridgehead id="logstash-setup" renderas="sect3">Configure Logstash to listen for Beats input<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara>Logstash provides <ulink url="http://www.elastic.co/guide/en/logstash/6.3/input-plugins.html">input plugins</ulink> for reading from
a variety of inputs. In this tutorial, you create a Logstash pipeline configuration
that listens for Beats input and sends the received events to the Elasticsearch output.</simpara>
<simpara>To configure Logstash:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Create a new Logstash pipeline configuration file called <literal>demo-metrics-pipeline.conf</literal>.
If you installed Logstash as a deb or rpm package, create the file in the Logstash
<literal>config</literal> directory. The file must contain:
</simpara>
<itemizedlist>
<listitem>
<simpara>
An input stage that configures Logstash to listen on port 5044 for incoming Beats
connections.
</simpara>
</listitem>
<listitem>
<simpara>
An output stage that indexes events into Elasticsearch. The output stage also
configures Logstash to write to the Metricbeat index.
</simpara>
</listitem>
</itemizedlist>
<simpara>For example:</simpara>
<programlisting language="ruby" linenumbering="unnumbered">input {
  beats {
    port =&gt; 5044
  }
}

# The filter part of this file is commented out to indicate that it
# is optional.
# filter {
#
# }

output {
  elasticsearch {
    hosts =&gt; "localhost:9200"
    manage_template =&gt; false
    index =&gt; "%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}"
  }
}</programlisting>
<simpara>When you start Logstash with this pipeline configuration, Beats events are routed
through Logstash, where you have full access to Logstash capabilities for collecting,
enriching, and transforming data.</simpara>
</listitem>
</orderedlist>
<bridgehead id="gs-start-logstash" renderas="sect3">Start Logstash<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara>Use the command that works with your system. If you installed Logstash as a deb or
rpm package, make sure the config file is in the <literal>config</literal> directory.</simpara>
<simpara><emphasis role="strong">deb:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">sudo /etc/init.d/logstash start</programlisting>
<simpara><emphasis role="strong">rpm:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">sudo service logstash start</programlisting>
<simpara><emphasis role="strong">mac:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">./bin/logstash -f demo-metrics-pipeline.conf</programlisting>
<simpara><emphasis role="strong">win:</emphasis></simpara>
<programlisting language="sh" linenumbering="unnumbered">bin\logstash.bat -f demo-metrics-pipeline.conf</programlisting>
<tip><simpara>If you receive JVM error messages, check your Java version as shown in
<ulink url="http://www.elastic.co/guide/en/logstash/6.3/installing-logstash.html">Installing Logstash</ulink>.</simpara></tip>
<simpara>Logstash starts listening for events from the Beats input. Next you need to
configure Metricbeat to send events to Logstash.</simpara>
<bridgehead id="_configure_metricbeat_to_send_events_to_logstash" renderas="sect3">Configure Metricbeat to send events to Logstash<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara>Metricbeat sends events to Elasticsearch by default. To send events to Logstash, modify the
Metricbeat configuration file, <literal>metricbeat.yml</literal>. You&#8217;ll find this file under
the Metricbeat install directory, or <literal>/etc/metricbeat</literal> for rpm and deb.</simpara>
<simpara>Disable the <literal>output.elasticsearch</literal> section by commenting it out, then enable
the <literal>output.logstash</literal> section by uncommenting it:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">#-------------------------- Elasticsearch output ------------------------------
#output.elasticsearch:
  # Array of hosts to connect to.
  #hosts: ["localhost:9200"]
.
.
.
#----------------------------- Logstash output --------------------------------
output.logstash:
  # The Logstash hosts
  hosts: ["localhost:5044"]</programlisting>
<simpara>Save the file, then restart Metricbeat to apply the configuration changes.</simpara>
<simpara>Logstash reads from the Beats input and indexes events into Elasticsearch. You haven&#8217;t
defined a filter section yet, so Logstash simply forwards events to Elasticsearch without
additional processing. Next, you learn how to define the filter stage.</simpara>
<bridgehead id="logstash-filter" renderas="sect3">Define a filter to extract data from a field<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara>The system metrics collected by Metricbeat include a field called <literal>cmdline</literal>
that contains the full command-line arguments used to start system processes.
For example:</simpara>
<programlisting language="json" linenumbering="unnumbered">"cmdline": "/Applications/Firefox.app/Contents/MacOS/plugin-container.app/Contents/MacOS/plugin-container -childID 3
-isForBrowser -boolPrefs 36:1|299:0| -stringPrefs 285:38;{b77ae304-9f53-a248-8bd4-a243dbf2cab1}| -schedulerPrefs
0001,2 -greomni /Applications/Firefox.app/Contents/Resources/omni.ja -appomni
/Applications/Firefox.app/Contents/Resources/browser/omni.ja -appdir
/Applications/Firefox.app/Contents/Resources/browser -profile
/Users/dedemorton/Library/Application Support/Firefox/Profiles/mftvzeod.default-1468353066634
99468 gecko-crash-server-pipe.99468 org.mozilla.machname.1911848630 tab"</programlisting>
<simpara>Rather than sending the whole command-line argument to Elasticsearch, you might want to
send just the command&#8217;s path. One way to do that is by using a Grok filter.
Learning Grok is beyond the scope of this tutorial, but if you want to learn
more, see the <ulink url="http://www.elastic.co/guide/en/logstash/6.3/plugins-filters-grok.html">Grok filter plugin</ulink>
documentation.</simpara>
<simpara>To extract the path, add the following Grok filter between the input and output
sections in the Logstash config file that you created earlier:</simpara>
<programlisting language="ruby" linenumbering="unnumbered">filter {
  if [system][process] {
    if [system][process][cmdline] {
      grok {
        match =&gt; { <co id="CO1-1"/>
          "[system][process][cmdline]" =&gt; "^%{PATH:[system][process][cmdline_path]}"
        }
        remove_field =&gt; "[system][process][cmdline]" <co id="CO1-2"/>
      }
    }
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO1-1">
<para>
Uses a pattern to match the path, then stores the path in a field called
<literal>cmdline_path</literal>.
</para>
</callout>
<callout arearefs="CO1-2">
<para>
Removes the original field, <literal>cmdline</literal>, so it&#8217;s not indexed in Elasticsearch.
</para>
</callout>
</calloutlist>
<simpara>When you&#8217;re done, the full configuration file should look like this:</simpara>
<programlisting language="ruby" linenumbering="unnumbered">input {
  beats {
    port =&gt; 5044
  }
}

filter {
  if [system][process] {
    if [system][process][cmdline] {
      grok {
        match =&gt; {
          "[system][process][cmdline]" =&gt; "^%{PATH:[system][process][cmdline_path]}"
        }
        remove_field =&gt; "[system][process][cmdline]"
      }
    }
  }
}

output {
  elasticsearch {
    hosts =&gt; "localhost:9200"
    manage_template =&gt; false
    index =&gt; "%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}"
  }
}</programlisting>
<simpara>Restart Logstash to pick up the changes. The event now includes a field called
<literal>cmdline_path</literal> that contains the command path:</simpara>
<programlisting language="ruby" linenumbering="unnumbered">"cmdline_path": "/Applications/Firefox.app/Contents/MacOS/plugin-container.app/Contents/MacOS/plugin-container"</programlisting>
<bridgehead id="_what_8217_s_next" renderas="sect3">What&#8217;s next?<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/getting-started/get-started-stack.asciidoc">Edit me</ulink></bridgehead>
<simpara>Congratulations! You&#8217;ve successfully set up the Elastic Stack. You learned how to
stream system metrics to Elasticsearch and visualize the data in Kibana. You also learned
how to use Logstash to filter events collected by Metricbeat.</simpara>
<simpara>Next, you&#8217;ll want to set up X-Pack security and activate your trial license so
you can unlock the full capabilities of the Elastic Stack. To learn how, read:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="xpack-security">Securing the Elastic Stack</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="license-management">License Management</link>
</simpara>
</listitem>
</itemizedlist>
<simpara>Later, when you&#8217;re ready to set up a production environment, also see the
<ulink url="http://www.elastic.co/guide/en/elastic-stack/6.3/installing-elastic-stack.html">Elastic Stack Installation and Upgrade
Guide</ulink>.</simpara>
</chapter>
<chapter id="xpack-setup" role="xpack">
<title>Setting Up X-Pack<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/xpack-setup.asciidoc">Edit me</ulink></title>
<itemizedlist>
<listitem>
<simpara>
<xref linkend="installing-xpack"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="xpack-upgrading"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="xpack-uninstalling"/>
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="xpack-settings"/>
</simpara>
</listitem>
</itemizedlist>
<section id="installing-xpack" role="xpack">
<title>Installing X-Pack<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/xpack-installing.asciidoc">Edit me</ulink></title>
<simpara>By default, when you install Elasticsearch, Kibana, and Logstash, X-Pack is installed.
For more information, see:</simpara>
<itemizedlist>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/install-elasticsearch.html">Installing Elasticsearch</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/kibana/6.3/install.html">Installing Kibana</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="http://www.elastic.co/guide/en/logstash/6.3/installing-logstash.html">Installing Logstash</ulink>
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="xpack-enabling" renderas="sect3">Enabling and Disabling X-Pack Features<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/xpack-installing.asciidoc">Edit me</ulink></bridgehead>
<simpara>By default, all basic X-Pack features are enabled. You can enable or disable
specific X-Pack features in the <literal>elasticsearch.yml</literal>, <literal>kibana.yml</literal>, and
<literal>logstash.yml</literal> configuration files.</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top"> Setting                           </entry>
<entry align="left" valign="top"> Description</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.graph.enabled</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Set to <literal>false</literal> to disable X-Pack graph features.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.ml.enabled</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Set to <literal>false</literal> to disable X-Pack machine learning features.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.monitoring.enabled</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Set to <literal>false</literal> to disable X-Pack monitoring features.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.reporting.enabled</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Set to <literal>false</literal> to disable X-Pack reporting features.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.security.enabled</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Set to <literal>false</literal> to disable X-Pack security features.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>xpack.watcher.enabled</literal></simpara></entry>
<entry align="left" valign="top"><simpara>Set to <literal>false</literal> to disable Watcher.</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>For more information about which settings exist in each configuration file, see
<ulink url="https://www.elastic.co/guide/en/elastic-stack-overview/6.3/xpack-settings.html">X-Pack Settings</ulink>.</simpara>
</section>
<section id="xpack-upgrading" role="xpack">
<title>Upgrading X-Pack<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/xpack-upgrading.asciidoc">Edit me</ulink></title>
<simpara>You must upgrade all of the Elastic Stack products you are using when upgrading
to a new major version. See
<ulink url="http://www.elastic.co/guide/en/elastic-stack/6.3/upgrading-elastic-stack.html">Upgrading the Elastic Stack</ulink>.</simpara>
<sidebar>
<simpara>The steps you need to take to upgrade differ depending on which products you
are using. Want a list that&#8217;s tailored to your stack? Try out our
<ulink url="https://www.elastic.co/products/upgrade_guide">Interactive Upgrade Guide</ulink>.</simpara>
</sidebar>
</section>
<section id="xpack-uninstalling" role="xpack">
<title>Uninstalling X-Pack<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/xpack-uninstalling.asciidoc">Edit me</ulink></title>
<simpara>X-Pack is installed with Elasticsearch, Kibana, and Logstash. It cannot be uninstalled
separately.</simpara>
</section>
<section id="xpack-settings" role="xpack">
<title>X-Pack Settings<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/xpack-settings.asciidoc">Edit me</ulink></title>
<simpara>You configure settings for X-Pack features in the <literal>elasticsearch.yml</literal>,
<literal>kibana.yml</literal>, and <literal>logstash.yml</literal> configuration files.</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top">X-Pack Feature   </entry>
<entry align="left" valign="top">Elasticsearch Settings                         </entry>
<entry align="left" valign="top">Kibana Settings                                </entry>
<entry align="left" valign="top">Logstash Settings</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>APM UI</simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/kibana/6.3/apm-settings-kb.html">Yes</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Development Tools</simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/kibana/6.3/dev-settings-kb.html">Yes</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Graph</simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/kibana/6.3/graph-settings-kb.html">Yes</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Machine learning</simpara></entry>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/ml-settings.html">Yes</ulink></simpara></entry>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/kibana/6.3/ml-settings-kb.html">Yes</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Management</simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
<entry align="left" valign="top"><simpara><ulink url="http://www.elastic.co/guide/en/logstash/6.3/configuring-centralized-pipelines.html#configuration-management-settings">Yes</ulink></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Monitoring</simpara></entry>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/monitoring-settings.html">Yes</ulink></simpara></entry>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/kibana/6.3/monitoring-settings-kb.html">Yes</ulink></simpara></entry>
<entry align="left" valign="top"><simpara><ulink url="http://www.elastic.co/guide/en/logstash/6.3/configuring-logstash.html#monitoring-settings">Yes</ulink></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Reporting</simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/kibana/6.3/reporting-settings-kb.html">Yes</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
</row>
<row>
<entry align="left" valign="top" morerows="1"><simpara>Security</simpara>
<itemizedlist>
<listitem>
<simpara>
Auditing
</simpara>
</listitem>
</itemizedlist></entry>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-settings.html">Yes</ulink></simpara></entry>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/kibana/6.3/security-settings-kb.html">Yes</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/auditing-settings.html">Yes</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Watcher</simpara></entry>
<entry align="left" valign="top"><simpara><ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/notification-settings.html">Yes</ulink></simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
<entry align="left" valign="top"><simpara>No</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>There are also <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/license-settings.html">X-Pack license settings</ulink> in the
<literal>elasticsearch.yml</literal> file.</simpara>
</section>
</chapter>
<chapter id="xpack-breaking-changes">
<title>Breaking Changes<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/xpack-breaking-changes.asciidoc">Edit me</ulink></title>
<simpara>This section discusses the changes that you need to be aware of when migrating
your application from one version to another.</simpara>
<simpara>As a general rule, we strive to keep backwards compatibility between minor
versions (for example, 5.x to 5.y), but there might be breaking changes between
major versions (for example, 5.x to 6.y).</simpara>
<simpara>See:</simpara>
<itemizedlist>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/breaking-changes.html">Elasticsearch Breaking Changes</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/kibana/6.3/breaking-changes.html">Kibana Breaking Changes</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="http://www.elastic.co/guide/en/logstash/6.3/breaking-changes.html">Logstash Breaking Changes</ulink>
</simpara>
</listitem>
</itemizedlist>
</chapter>
<chapter id="xpack-api" role="xpack">
<title>X-Pack APIs<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/xpack-apis.asciidoc">Edit me</ulink></title>
<simpara>X-Pack exposes a wide range of REST APIs to manage and monitor its features.</simpara>
<itemizedlist>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/info-api.html">Info API</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/graph-explore-api.html">Graph APIs</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/ml-apis.html">Machine Learning APIs</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-api.html">Security APIs</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/watcher-api.html">Watcher APIs</ulink>
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/ml-api-definitions.html">Definitions</ulink>
</simpara>
</listitem>
</itemizedlist>
</chapter>
<part id="xpack-security" role="xpack">
<title>Securing the Elastic Stack<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/index.asciidoc">Edit me</ulink></title>
<partintro>
<simpara>X-Pack security enables you to easily secure a cluster. With X-Pack security,
you can password-protect your data as well as implement more advanced security
measures such as encrypting communications, role-based access control,
IP filtering, and auditing. This guide describes how to configure the security
features you need, and interact with your secured cluster.</simpara>
<simpara>Security protects Elasticsearch clusters by:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="preventing-unauthorized-access">Preventing unauthorized access</link>
  with password protection, role-based access control, and IP filtering.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="preserving-data-integrity">Preserving the integrity of your data</link>
  with message authentication and SSL/TLS encryption.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="maintaining-audit-trail">Maintaining an audit trail</link>
  so you know who&#8217;s doing what to your cluster and the data it stores.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="preventing-unauthorized-access" renderas="sect2">Preventing Unauthorized Access<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/index.asciidoc">Edit me</ulink></bridgehead>
<simpara>To prevent unauthorized access to your Elasticsearch cluster, you must have a
way to <emphasis>authenticate</emphasis> users. This simply means that you need a way to validate
that a user is who they claim to be. For example, you have to make sure only
the person named <emphasis>Kelsey Andorra</emphasis> can sign in as the user <literal>kandorra</literal>. X-Pack
Security provides a standalone authentication mechanism that enables you to
quickly password-protect your cluster. If you&#8217;re already using <link linkend="ldap-realm">LDAP</link>,
<link linkend="active-directory-realm">Active Directory</link>, or <link linkend="pki-realm">PKI</link> to manage
users in your organization, X-Pack security is able to integrate with those
systems to perform user authentication.</simpara>
<simpara>In many cases, simply authenticating users isn&#8217;t enough. You also need a way to
control what data users have access to and what tasks they can perform. X-Pack security
enables you to <emphasis>authorize</emphasis> users by assigning access <emphasis>privileges</emphasis> to <emphasis>roles</emphasis>,
and assigning those roles to users. For example, this
<link linkend="authorization">role-based access control</link> mechanism (a.k.a RBAC) enables
you to specify that the user <literal>kandorra</literal> can only perform read operations on the
<literal>events</literal> index and can&#8217;t do anything at all with other indices.</simpara>
<simpara>X-Pack security also supports <link linkend="ip-filtering">IP-based authorization</link>. You can
whitelist and blacklist specific IP addresses or subnets to control network-level
access to a server.</simpara>
<bridgehead id="preserving-data-integrity" renderas="sect2">Preserving Data Integrity<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/index.asciidoc">Edit me</ulink></bridgehead>
<simpara>A critical part of security is keeping confidential data confidential.
Elasticsearch has built-in protections against accidental data loss and
corruption. However, there&#8217;s nothing to stop deliberate tampering or data
interception. X-Pack security preserves the integrity of your data by
<link linkend="ssl-tls">encrypting communications</link> to and from nodes.
For even greater protection, you can increase the <link linkend="ciphers">encryption strength</link> and
<link linkend="separating-node-client-traffic">separate client traffic from node-to-node communications</link>.</simpara>
<bridgehead id="maintaining-audit-trail" renderas="sect2">Maintaining an Audit Trail<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/index.asciidoc">Edit me</ulink></bridgehead>
<simpara>Keeping a system secure takes vigilance. By using X-Pack security to maintain
an audit trail, you can easily see who is accessing your cluster and what they&#8217;re
doing. By analyzing access patterns and failed attempts to access your cluster,
you can gain insights into attempted attacks and data breaches. Keeping an
auditable log of the activity in your cluster can also help diagnose operational
issues.</simpara>
<bridgehead id="_where_to_go_next_2" renderas="sect2">Where to Go Next<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/index.asciidoc">Edit me</ulink></bridgehead>
<itemizedlist>
<listitem>
<simpara>
<link linkend="security-getting-started">Getting Started</link>
  steps through how to install and start using Security for basic authentication.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="how-security-works">How Security Works</link>
  provides more information about how Security supports user authentication,
  authorization, and encryption.
</simpara>
</listitem>
<listitem>
<simpara>
<xref linkend="ccs-tribe-clients-integrations"/>
  shows you how to interact with an Elasticsearch cluster protected by
  X-Pack Security.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="security-reference">Reference</link>
  provides detailed information about the access privileges you can grant to
  users, the settings you can configure for Security in <literal>elasticsearch.yml</literal>,
  and the files where Security configuration information is stored.
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_have_comments_questions_or_feedback_2" renderas="sect2">Have Comments, Questions, or Feedback?<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/index.asciidoc">Edit me</ulink></bridgehead>
<simpara>Head over to our <ulink url="https://discuss.elastic.co/c/x-pack/shield">Security Discussion Forum</ulink>
to share your experience, questions, and suggestions.</simpara>
</partintro>
<chapter id="security-getting-started" role="xpack">
<title>Getting started with security<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/get-started-security.asciidoc">Edit me</ulink></title>
<simpara>In this tutorial, you learn how to secure a cluster by configuring users and
roles in Elasticsearch, Kibana, Logstash, and Metricbeat.</simpara>
<bridgehead id="get-started-security-prerequisites" renderas="sect2">Before you begin<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/get-started-security.asciidoc">Edit me</ulink></bridgehead>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Install and configure Elasticsearch, Kibana, Logstash, and Metricbeat as described in
<xref linkend="get-started-elastic-stack"/>.
</simpara>
</listitem>
<listitem>
<simpara>
Stop Logstash. The method for starting and stopping Logstash varies depending on whether
you are running it from the command line or running it as a service. For example,
if you are running Logstash from the command line, you can stop it by entering
<literal>Ctrl-C</literal>. See <ulink url="http://www.elastic.co/guide/en/logstash/6.3/shutdown.html">Shutting down Logstash</ulink>.
</simpara>
</listitem>
<listitem>
<simpara>
Stop Metricbeat. For example, enter <literal>Ctrl-C</literal> on the command line where it is
running.
</simpara>
</listitem>
<listitem>
<simpara>
Launch the Kibana web interface by pointing your browser to port 5601. For
example, <ulink url="http://127.0.0.1:5601">http://127.0.0.1:5601</ulink>.
</simpara>
</listitem>
</orderedlist>
<section id="get-started-license" role="xpack">
<title>Install a trial license<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/get-started-security.asciidoc">Edit me</ulink></title>
<simpara>By default, when you install Elastic Stack products, they apply basic licenses with no
expiration dates. To view your license in Kibana, go to <emphasis role="strong">Management</emphasis> and click
<emphasis role="strong">License Management</emphasis>.</simpara>
<informalfigure role="screenshot">
<mediaobject>
  <imageobject>
  <imagedata fileref="images/management-license.png"/>
  </imageobject>
  <textobject><phrase>The License Management page in Kibana</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>For more information about Elastic license levels, see
<ulink url="https://www.elastic.co/subscriptions">https://www.elastic.co/subscriptions</ulink>.</simpara>
<simpara>You can start a 30-day trial to try out all of the platinum features, including
X-Pack security and machine learning. Click <emphasis role="strong">Start trial</emphasis> on the <emphasis role="strong">License Management</emphasis> page in
Kibana.</simpara>
<important><simpara>If your cluster has already activated a trial license for the current
major version, you cannot start a new trial. For example, if you have already
activated a trial for v6.0, you cannot start a new trial until v7.0.</simpara></important>
<simpara>At the end of the trial period, the platinum features operate in a
<link linkend="license-expiration">degraded mode</link>. You can revert to a basic license, extend
the trial, or purchase a subscription.</simpara>
</section>
<section id="get-started-enable-security" role="xpack">
<title>Enable security in Elasticsearch<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/get-started-security.asciidoc">Edit me</ulink></title>
<simpara>When you use the trial license, X-Pack security is disabled by default. To enable it:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Stop Kibana. The method for starting and stopping Kibana varies depending on
how you installed it. For example, if you installed Kibana from an archive
distribution (<literal>.tar.gz</literal> or <literal>.zip</literal>), stop it by entering <literal>Ctrl-C</literal> on the command
line. See <ulink url="https://www.elastic.co/guide/en/kibana/6.3/start-stop.html">Starting and stopping Kibana</ulink>.
</simpara>
</listitem>
<listitem>
<simpara>
Stop Elasticsearch. For example, if you installed Elasticsearch from an archive distribution,
enter <literal>Ctrl-C</literal> on the command line. See
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/stopping-elasticsearch.html">Stopping Elasticsearch</ulink>.
</simpara>
</listitem>
<listitem>
<simpara>
Add the <literal>xpack.security.enabled</literal> setting to the
<literal>ES_PATH_CONF/elasticsearch.yml</literal> file.
</simpara>
<tip><simpara>The <literal>ES_PATH_CONF</literal> environment variable contains the path for the Elasticsearch
configuration files. If you installed Elasticsearch using archive distributions (<literal>zip</literal> or
<literal>tar.gz</literal>), it defaults to <literal>ES_HOME/config</literal>. If you used package distributions
(Debian or RPM), it defaults to <literal>/etc/elasticsearch</literal>. For more information, see
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/settings.html">Configuring Elasticsearch</ulink>.</simpara></tip>
<simpara>For example, add the following setting:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.enabled: true</programlisting>
<tip><simpara>If you have a basic or trial license, the default value for this setting is
<literal>false</literal>. If you have a gold or higher license, the default value is <literal>true</literal>.
Therefore, it is a good idea to explicitly add this setting to avoid confusion
about whether X-Pack security is enabled.</simpara></tip>
</listitem>
</orderedlist>
<simpara>When you enable X-Pack security, basic authentication is enabled by default. To
communicate with the cluster, you must specify a username and password.
Unless you <link linkend="anonymous-access">enable anonymous access</link>, all requests that don&#8217;t
include a user name and password are rejected.</simpara>
<note><simpara>This tutorial involves a single node cluster, but if you had multiple
nodes, you would enable X-Pack security on every node in the cluster and configure
Transport Layer Security (TLS) for internode-communication, which is beyond the
scope of this tutorial.</simpara></note>
</section>
<section id="get-started-built-in-users" role="xpack">
<title>Create passwords for built-in users<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/get-started-security.asciidoc">Edit me</ulink></title>
<simpara>There are built-in users that you can use for specific administrative purposes:
<literal>elastic</literal>, <literal>kibana</literal>, <literal>logstash_system</literal>, and <literal>beats_system</literal>.</simpara>
<simpara>Before you can use them, you must set their passwords:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Restart Elasticsearch. For example, if you installed Elasticsearch with a <literal>.tar.gz</literal> package, run
the following command from the Elasticsearch directory:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">./bin/elasticsearch</programlisting>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/starting-elasticsearch.html">Starting Elasticsearch</ulink>.</simpara>
</listitem>
<listitem>
<simpara>
Set the built-in users' passwords. Run the following command from the Elasticsearch
directory:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">./bin/elasticsearch-setup-passwords interactive</programlisting>
</listitem>
</orderedlist>
<simpara>You need these built-in users in subsequent steps, so choose passwords that you
can remember!</simpara>
<note><simpara>This tutorial does not use the built-in <literal>logstash_system</literal> and
<literal>beats_system</literal> users, which are typically associated with monitoring. For more
information, see
<ulink url="http://www.elastic.co/guide/en/logstash/6.3/ls-security.html#ls-monitoring-user">Configuring credentials for Logstash monitoring</ulink>
and <ulink url="https://www.elastic.co/guide/en/beats/metricbeat/6.3/monitoring.html">Monitoring Metricbeat</ulink>.</simpara></note>
</section>
<section id="get-started-kibana-user" role="xpack">
<title>Add the built-in user to Kibana<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/get-started-security.asciidoc">Edit me</ulink></title>
<simpara>When X-Pack security is enabled, users must log in to Kibana with a valid user ID and
password.</simpara>
<simpara>Kibana also performs some tasks under the covers that require use of the
built-in <literal>kibana</literal> user.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Configure Kibana to use the built-in <literal>kibana</literal> user and the password that you
created:
</simpara>
<itemizedlist>
<listitem>
<simpara>
If you don&#8217;t mind having passwords visible in your configuration file,
uncomment and update the following settings in the <literal>kibana.yml</literal> file in your
Kibana directory:
</simpara>
<tip><simpara>If you installed Kibana using archive distributions (<literal>zip</literal> or
<literal>tar.gz</literal>), the <literal>kibana.yml</literal> configuration file is in <literal>KIBANA_HOME/config</literal>. If
you used package distributions (Debian or RPM), it&#8217;s in <literal>/etc/kibana</literal>. For more
information, see <ulink url="https://www.elastic.co/guide/en/kibana/6.3/settings.html">Configuring Kibana</ulink>.</simpara></tip>
<simpara>For example, add the following settings:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">elasticsearch.username: "kibana"
elasticsearch.password: "your_password"</programlisting>
<simpara>Specify the password that you set with the <literal>elasticsearch-setup-passwords</literal>
command then save your changes to the file.</simpara>
</listitem>
<listitem>
<simpara>
If you prefer not to put your user ID and password in the <literal>kibana.yml</literal> file,
store them in a keystore instead. Run the following commands to create the Kibana
keystore and add the secure settings:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">./bin/kibana-keystore create
./bin/kibana-keystore add elasticsearch.username
./bin/kibana-keystore add elasticsearch.password</programlisting>
<simpara>When prompted, specify the <literal>kibana</literal> built-in user and its password for these
setting values.  The settings are automatically applied when you start Kibana.
To learn more, see <ulink url="https://www.elastic.co/guide/en/kibana/6.3/secure-settings.html">Secure settings</ulink>.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>
Restart Kibana. For example, if you installed
Kibana with a <literal>.tar.gz</literal> package, run the following command from the Kibana
directory:
</simpara>
<programlisting language="sh" linenumbering="unnumbered">./bin/kibana</programlisting>
<simpara>See <ulink url="https://www.elastic.co/guide/en/kibana/6.3/start-stop.html">Starting and stopping Kibana</ulink>.</simpara>
</listitem>
</orderedlist>
</section>
<section id="get-started-authentication" role="xpack">
<title>Configure authentication<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/get-started-security.asciidoc">Edit me</ulink></title>
<simpara>Now that you&#8217;ve set up the built-in users, you need to decide how you want to
manage all the other users.</simpara>
<simpara>The Elastic Stack <emphasis>authenticates</emphasis> users to ensure that they are valid. The
authentication process is handled by <emphasis>realms</emphasis>. You can use one or more built-in
realms, such as the native, file, LDAP, PKI, Active Directory, or SAML realms.
Alternatively, you can create your own custom realms. In this tutorial, we&#8217;ll
use a native realm.</simpara>
<simpara>In general, you configure realms by adding <literal>xpack.security.authc.realms</literal>
settings in the <literal>elasticsearch.yml</literal> file. However, the native realm is available
by default when no other realms are configured. Therefore, you don&#8217;t need to do
any extra configuration steps in this tutorial. You can jump straight to
creating users!</simpara>
<simpara>If you want to learn more about authentication and realms, see
<xref linkend="setting-up-authentication"/>.</simpara>
</section>
<section id="get-started-users" role="xpack">
<title>Create users<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/get-started-security.asciidoc">Edit me</ulink></title>
<simpara>Let&#8217;s create two users in the native realm.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Log in to Kibana with the <literal>elastic</literal> built-in user.
</simpara>
</listitem>
<listitem>
<simpara>
Go to the <emphasis role="strong">Management / Security / Users</emphasis> page:
</simpara>
<informalfigure role="screenshot">
<mediaobject>
  <imageobject>
  <imagedata fileref="security/images/management-builtin-users.jpg"/>
  </imageobject>
  <textobject><phrase>User management screenshot in Kibana</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>In this example, you can see all of the built-in users.</simpara>
</listitem>
<listitem>
<simpara>
Click <emphasis role="strong">Create user</emphasis> to make a new user. For example, create a user for yourself:
</simpara>
<informalfigure role="screenshot">
<mediaobject>
  <imageobject>
  <imagedata fileref="security/images/create-user.jpg"/>
  </imageobject>
  <textobject><phrase>Creating a user in Kibana</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>You&#8217;ll notice that when you create a user, you can assign it a role. Don&#8217;t
choose a role yet&#8212;we&#8217;ll come back to that in subsequent steps.</simpara>
</listitem>
<listitem>
<simpara>
Click <emphasis role="strong">Create user</emphasis> and create a <literal>logstash_internal</literal> user.
</simpara>
<simpara>In <xref linkend="get-started-elastic-stack"/>, you configured Logstash to listen for Metricbeat
input and to send the events to Elasticsearch.  You therefore need to create a user
that Logstash can use to communicate with Elasticsearch. For example:</simpara>
<informalfigure role="screenshot">
<mediaobject>
  <imageobject>
  <imagedata fileref="security/images/create-logstash-user.jpg"/>
  </imageobject>
  <textobject><phrase>Creating a Logstash user in Kibana</phrase></textobject>
</mediaobject>
</informalfigure>
</listitem>
</orderedlist>
</section>
<section id="get-started-roles" role="xpack">
<title>Assign roles<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/get-started-security.asciidoc">Edit me</ulink></title>
<simpara>By default, all users can change their own passwords, get information about
themselves, and run the <literal>authenticate</literal> API. If you want them to do more than
that, you need to give them one or more <emphasis>roles</emphasis>.</simpara>
<simpara>Each role defines a specific set of actions (such as read, create, or delete)
that can be performed on specific secured resources (such as indices, aliases,
documents, fields, or clusters). To help you get up and running, there are
built-in roles.</simpara>
<simpara>Go to the <emphasis role="strong">Management / Security / Roles</emphasis> page to see them:</simpara>
<informalfigure role="screenshot">
<mediaobject>
  <imageobject>
  <imagedata fileref="security/images/management-roles.jpg"/>
  </imageobject>
  <textobject><phrase>Role management screenshot in Kibana</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>Select a role to see more information about its privileges. For example, if you
select the <literal>kibana_user</literal> role, you will see that it grants <literal>manage</literal>, <literal>read</literal>,
<literal>index</literal>, and <literal>delete</literal> privileges on the <literal>.kibana*</literal> indices. To learn more about
these privileges, see <xref linkend="privileges-list-indices"/>.</simpara>
<simpara>Let&#8217;s assign the <literal>kibana_user</literal> role to your user. Go back to the
<emphasis role="strong">Management / Security / Users</emphasis> page and select your user. Add the <literal>kibana_user</literal>
role and save the change. For example:</simpara>
<informalfigure role="screenshot">
<mediaobject>
  <imageobject>
  <imagedata fileref="security/images/assign-role.jpg"/>
  </imageobject>
  <textobject><phrase>Assigning a role to a user in Kibana</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>This user now has the minimum privileges required to use Kibana.</simpara>
<simpara>If you completed all of the steps in <xref linkend="get-started-elastic-stack"/>, you should
have Metricbeat data stored in Elasticsearch. Let&#8217;s create two roles that grant
different levels of access to that data.</simpara>
<simpara>Go to the <emphasis role="strong">Management / Security / Roles</emphasis> page and click <emphasis role="strong">Create role</emphasis>.</simpara>
<simpara>Create a <literal>metricbeat_reader</literal> role that has <literal>read</literal> and <literal>view_index_metadata</literal>
privileges on the <literal>metricbeat-*</literal> indices:</simpara>
<informalfigure role="screenshot">
<mediaobject>
  <imageobject>
  <imagedata fileref="security/images/create-reader-role.jpg"/>
  </imageobject>
  <textobject><phrase>Creating a role in Kibana</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>Create a <literal>metricbeat_writer</literal> role that has <literal>manage_index_templates</literal> and <literal>monitor</literal>
cluster privileges, as well as <literal>write</literal>, <literal>delete</literal>, and <literal>create_index</literal> privileges
on the <literal>metricbeat-*</literal> indices:</simpara>
<informalfigure role="screenshot">
<mediaobject>
  <imageobject>
  <imagedata fileref="security/images/create-writer-role.jpg"/>
  </imageobject>
  <textobject><phrase>Creating another role in Kibana</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>Now go back to the <emphasis role="strong">Management / Security / Users</emphasis> page and assign these roles
to the appropriate users. Assign the <literal>metricbeat_reader</literal> role to your personal
user.  Assign the <literal>metricbeat_writer</literal> role to the <literal>logstash_internal</literal> user.</simpara>
<simpara>The list of users should now contain all of the built-in users as well as the
two you created. It should also show the appropriate roles for your users:</simpara>
<informalfigure role="screenshot">
<mediaobject>
  <imageobject>
  <imagedata fileref="security/images/management-users.jpg"/>
  </imageobject>
  <textobject><phrase>User management screenshot in Kibana</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>If you want to learn more about authorization and roles, see <xref linkend="authorization"/>.</simpara>
</section>
<section id="get-started-logstash-user" role="xpack">
<title>Add user information in Logstash<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/get-started-security.asciidoc">Edit me</ulink></title>
<simpara>In order for Logstash to send data successfully to Elasticsearch, you must configure its
authentication credentials in the Logstash configuration file.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Configure Logstash to use the <literal>logstash_internal</literal> user and the password that you
created:
</simpara>
<itemizedlist>
<listitem>
<simpara>
If you don&#8217;t mind having passwords visible in your configuration file, add
the following <literal>user</literal> and <literal>password</literal> settings in the <literal>demo-metrics-pipeline.conf</literal>
file in your Logstash directory:
</simpara>
<programlisting language="ruby" linenumbering="unnumbered">...

output {
  elasticsearch {
    hosts =&gt; "localhost:9200"
    manage_template =&gt; false
    index =&gt; "%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}"
    user =&gt; "logstash_internal" <co id="CO2-1"/>
    password =&gt; "your_password" <co id="CO2-2"/>
  }
}</programlisting>
<calloutlist>
<callout arearefs="CO2-1">
<para>
Specify the <literal>logstash_internal</literal> user that you created earlier in this tutorial.
</para>
</callout>
<callout arearefs="CO2-2">
<para>
Specify the password that you chose for this user ID.
</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>
If you prefer not to put your user ID and password in the configuration file,
store them in a keystore instead.
</simpara>
<simpara>Run the following commands to create the Logstash
keystore and add the secure settings:</simpara>
<programlisting language="sh" linenumbering="unnumbered">set +o history
export LOGSTASH_KEYSTORE_PASS=mypassword <co id="CO3-1"/>
set -o history
./bin/logstash-keystore create
./bin/logstash-keystore add ES_USER
./bin/logstash-keystore add ES_PWD</programlisting>
<calloutlist>
<callout arearefs="CO3-1">
<para>
You can optionally protect access to the Logstash keystore by storing a password
in an environment variable called <literal>LOGSTASH_KEYSTORE_PASS</literal>. For more information,
see <ulink url="http://www.elastic.co/guide/en/logstash/6.3/keystore.html#keystore-password">Keystore password</ulink>.
</para>
</callout>
</calloutlist>
<simpara>When prompted, specify the <literal>logstash_internal</literal> user and its password for the
<literal>ES_USER</literal> and <literal>ES_PWD</literal> values.</simpara>
<note><simpara>The Logstash keystore differs from the Kibana keystore. Whereas the Kibana
keystore enables you to store <literal>kibana.yml</literal> settings by name, the Logstash keystore
enables you to create arbitrary names that you can reference in the Logstash
configuration. To learn more, see
<ulink url="http://www.elastic.co/guide/en/logstash/6.3/keystore.html">Secrets keystore for secure settings</ulink>.</simpara></note>
<simpara>You can now use these <literal>ES_USER</literal> and <literal>ES_PWD</literal> keys in your configuration
file.  For example, add the <literal>user</literal> and <literal>password</literal> settings in the
<literal>demo-metrics-pipeline.conf</literal> file as follows:</simpara>
<programlisting language="ruby" linenumbering="unnumbered">...

output {
  elasticsearch {
    hosts =&gt; "localhost:9200"
    manage_template =&gt; false
    index =&gt; "%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}"
    user =&gt; "${ES_USER}"
    password =&gt; "${ES_PWD}"
  }
}</programlisting>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>
Start Logstash by using the appropriate method for your environment.
</simpara>
<simpara>For example, to
run Logstash from a command line, go to the Logstash directory and enter the following
command:</simpara>
<programlisting language="sh" linenumbering="unnumbered">./bin/logstash -f demo-metrics-pipeline.conf</programlisting>
<simpara>To start Logstash as a service, see
<ulink url="http://www.elastic.co/guide/en/logstash/6.3/running-logstash.html">Running Logstash as a service on Debian or RPM</ulink>.</simpara>
</listitem>
<listitem>
<simpara>
If you were connecting directly from Metricbeat to Elasticsearch, you would need
to configure authentication credentials for the Elasticsearch output in the Metricbeat
configuration file. In <xref linkend="get-started-elastic-stack"/>, however, you configured
Metricbeat to send the data to Logstash for additional parsing, so no extra
settings are required in Metricbeat. For more information, see
<ulink url="https://www.elastic.co/guide/en/beats/metricbeat/6.3/securing-metricbeat.html">Securing Metricbeat</ulink>.
</simpara>
</listitem>
<listitem>
<simpara>
Start Metricbeat by using the appropriate method for your environment.
</simpara>
<simpara>For example, on macOS, run the following command from the Metricbeat directory:</simpara>
<programlisting language="sh" linenumbering="unnumbered">./metricbeat -e</programlisting>
<simpara>For more methods, see <ulink url="https://www.elastic.co/guide/en/beats/metricbeat/6.3/metricbeat-starting.html">Starting Metricbeat</ulink>.</simpara>
</listitem>
</orderedlist>
<simpara>Wait a few minutes for new data to be sent from Metricbeat to Logstash and Elasticsearch.</simpara>
</section>
<section id="get-started-verify-users" role="xpack">
<title>View system metrics in Kibana<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/get-started-security.asciidoc">Edit me</ulink></title>
<simpara>Log in to Kibana with the user ID that has <literal>metricbeat_reader</literal> and <literal>kibana_user</literal>
roles (for example, <literal>jdoe</literal>).</simpara>
<simpara>These roles enable the user to see the system metrics in Kibana (for example, on
the <emphasis role="strong">Discover</emphasis> page or in the
<ulink url="http://localhost:5601/app/kibana#/dashboard/Metricbeat-system-overview">Metricbeat system overview dashboard</ulink>).</simpara>
<bridgehead id="gs-security-nextsteps" renderas="sect2">What&#8217;s next?<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/get-started-security.asciidoc">Edit me</ulink></bridgehead>
<simpara>Congratulations! You&#8217;ve successfully set up authentication and authorization by
using the native realm. You learned how to create user IDs and roles that
prevent unauthorized access to the Elastic Stack.</simpara>
<simpara>Next, you&#8217;ll want to try other features that are unlocked by your trial license,
such as machine learning. See <link linkend="ml-getting-started">Getting started with machine learning</link>.</simpara>
<simpara>Later, when you&#8217;re ready to increase the number of nodes in your cluster or set
up an production environment, you&#8217;ll want to encrypt communications across the
Elastic Stack. To learn how, read <xref linkend="encrypting-communications"/>.</simpara>
<simpara>For more detailed information about securing the Elastic Stack, see:</simpara>
<itemizedlist>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/configuring-security.html">Configuring security in Elasticsearch</ulink>. Encrypt
inter-node communications, set passwords for the built-in users, and manage your
users and roles.
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/kibana/6.3/using-kibana-with-security.html">Configuring security in Kibana</ulink>.
Set the authentication credentials in Kibana and encrypt communications between
the browser and the Kibana server.
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="http://www.elastic.co/guide/en/logstash/6.3/ls-security.html">Configuring security in Logstash</ulink>. Set the
authentication credentials for Logstash and encrypt communications between
Logstash and Elasticsearch.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="beats">Configuring security in the Beats</link>. Configure authentication
credentials and encrypt connections to Elasticsearch.
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="java-clients">Configuring the Java transport client to use encrypted communications</link>.
</simpara>
</listitem>
<listitem>
<simpara>
<ulink url="https://www.elastic.co/guide/en/elasticsearch/hadoop/6.3/security.html">Configuring Elasticsearch for Apache Hadoop to use secured transport</ulink>.
</simpara>
</listitem>
</itemizedlist>
</section>
</chapter>
<chapter id="how-security-works" role="xpack">
<title>How security works<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/how-security-works.asciidoc">Edit me</ulink></title>
<simpara>An Elasticsearch cluster is typically made out of many moving parts. There are
the Elasticsearch nodes that form the cluster, and often Logstash instances,
Kibana instances, Beats agents an clients, all communicating with the it.
It should not come as a surprise that securing such clusters has many facets and
layers.</simpara>
<simpara>X-Pack security provides the means to secure the Elastic cluster on several levels:</simpara>
<itemizedlist>
<listitem>
<simpara>
<link linkend="setting-up-authentication">User authentication</link>
</simpara>
</listitem>
<listitem>
<simpara>
<link linkend="authorization">User authorization and access control</link>
</simpara>
</listitem>
<listitem>
<simpara>
Node/client authentication and channel encryption
</simpara>
</listitem>
<listitem>
<simpara>
Auditing
</simpara>
</listitem>
</itemizedlist>
<bridgehead id="_node_client_authentication_and_channel_encryption" renderas="sect2">Node/client authentication and channel encryption<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/how-security-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>X-Pack security supports configuring SSL/TLS for securing the communication channels
to, from and within the cluster. This support accounts for:</simpara>
<itemizedlist>
<listitem>
<simpara>
Encryption of data transmitted over the wires
</simpara>
</listitem>
<listitem>
<simpara>
Certificate based node authentication - preventing unauthorized nodes/clients
    from establishing a connection with the cluster.
</simpara>
</listitem>
</itemizedlist>
<simpara>For more information, see <link linkend="encrypting-communications">Encrypting Communications</link>.</simpara>
<simpara>X-Pack security also enables you to <link linkend="ip-filtering">configure IP Filters</link> which can
be seen as a light mechanism for node/client authentication. With IP Filtering
you can restrict the nodes and clients that can connect to the cluster based
on their IP addresses. The IP filters configuration provides whitelisting
and blacklisting of IPs, subnets and DNS domains.</simpara>
<bridgehead id="_auditing" renderas="sect2">Auditing<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/how-security-works.asciidoc">Edit me</ulink></bridgehead>
<simpara>When dealing with any secure system, it is critical to have a audit trail
mechanism set in place. Audit trails log various activities/events that occur in
the system, enabling you to analyze and back track past events when things go
wrong (e.g. security breach).</simpara>
<simpara>X-Pack security provides such audit trail functionality for all nodes in the cluster.
You can configure the audit level which accounts for the type of events that are
logged. These events include failed authentication attempts, user access denied,
node connection denied, and more.</simpara>
<simpara>For more information on auditing see <xref linkend="auditing"/>.</simpara>
</chapter>
<chapter id="setting-up-authentication" role="xpack">
<title>User authentication<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>Authentication identifies an individual. To gain access to restricted resources,
a user must prove their identity, via passwords, credentials, or some other
means (typically referred to as authentication tokens).</simpara>
<simpara>The Elastic Stack authenticates users by identifying the users behind the requests
that hit the cluster and verifying that they are who they claim to be. The
authentication process is handled by one or more authentication services called
<link linkend="realms"><emphasis>realms</emphasis></link>.</simpara>
<simpara>You can use the native support for managing and authenticating users, or
integrate with external user management systems such as LDAP and Active
Directory.</simpara>
<simpara>X-Pack security provides built-in realms such as <literal>native</literal>,<literal>ldap</literal>, <literal>active_directory</literal>,
<literal>pki</literal>, <literal>file</literal>, and <literal>saml</literal>. If none of the built-in realms meet your needs, you
can also build your own custom realm and plug it into the Elastic Stack.</simpara>
<simpara>When X-Pack security is enabled, depending on the realms you&#8217;ve configured, you must
attach your user credentials to the requests sent to Elasticsearch. For example, when
using realms that support usernames and passwords you can simply attach
<ulink url="https://en.wikipedia.org/wiki/Basic_access_authentication">basic auth</ulink> header to the requests.</simpara>
<section id="built-in-users" role="xpack">
<title>Built-in users<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>X-Pack security provides built-in user credentials to help you get up and running.
These users have a fixed set of privileges and cannot be authenticated until their
passwords have been set. The <literal>elastic</literal> user can be used to
<link linkend="set-built-in-user-passwords">set all of the built-in user passwords</link>.</simpara>
<variablelist>
<varlistentry>
<term>
<literal>elastic</literal>
</term>
<listitem>
<simpara>
A built-in <emphasis>superuser</emphasis>. See <xref linkend="built-in-roles"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>kibana</literal>
</term>
<listitem>
<simpara>
The user Kibana uses to connect and communicate with Elasticsearch.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>logstash_system</literal>
</term>
<listitem>
<simpara>
The user Logstash uses when storing monitoring information in Elasticsearch.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>beats_system</literal>
</term>
<listitem>
<simpara>
The user the Beats use when storing monitoring information in Elasticsearch.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<bridgehead id="built-in-user-explanation" renderas="sect3">How the built-in users work<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></bridgehead>
<simpara>These built-in users are stored within a special <literal>.security</literal> index managed by
X-Pack security.
This means that, if the password is changed, or a user is disabled, then that
change is automatically reflected on each node in the cluster. It also means
that if your <literal>.security</literal> index is deleted, or restored from a snapshot, then
any changes you have applied will be lost.</simpara>
<simpara>Although they share the same API, the built-in users are separate and distinct
from users managed by the <link linkend="native-realm">native realm</link>. Disabling the native
realm will not have any effect on the built-in users. The built-in users can
be disabled individually, using the
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-api-users.html">user management API</ulink>.</simpara>
<bridgehead id="bootstrap-elastic-passwords" renderas="sect3">The Elastic bootstrap password<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></bridgehead>
<simpara>When you install Elasticsearch, if the <literal>elastic</literal> user does not already have a password,
it uses a default bootstrap password. The bootstrap password is a transient
password that enables you to run the tools that set all the built-in user passwords.</simpara>
<simpara>By default, the bootstrap password is derived from a randomized <literal>keystore.seed</literal>
setting, which is added to the keystore during installation. You do not need
to know or change this bootstrap password. If you have defined a
<literal>bootstrap.password</literal> setting in the keystore, however, that value is used instead.
For more information about interacting with the keystore, see
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/secure-settings.html">Secure Settings</ulink>.</simpara>
<note><simpara>After you <link linkend="set-built-in-user-passwords">set passwords for the built-in users</link>,
in particular for the <literal>elastic</literal> user, there is no further use for the bootstrap
password.</simpara></note>
<bridgehead id="set-built-in-user-passwords" renderas="sect3">Setting built-in user passwords<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></bridgehead>
<simpara>You must set the passwords for all built-in users.</simpara>
<simpara>The <literal>elasticsearch-setup-passwords</literal> tool is the simplest method to set the
built-in users' passwords for the first time. It uses the <literal>elastic</literal> user&#8217;s
bootstrap password to run user management API requests. For example, you can run
the command in an "interactive" mode, which prompts you to enter new passwords
for the <literal>elastic</literal>, <literal>kibana</literal>, <literal>logstash_system</literal>, and <literal>beats_system</literal> users:</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/elasticsearch-setup-passwords interactive</programlisting>
<simpara>For more information about the command options, see
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/setup-passwords.html">elasticsearch-setup-passwords</ulink>.</simpara>
<important><simpara>After you set a password for the <literal>elastic</literal> user, the bootstrap
password is no longer valid; you cannot run the <literal>elasticsearch-setup-passwords</literal>
command a second time.</simpara></important>
<simpara>Alternatively, you can set the initial passwords for the built-in users by using
the <emphasis role="strong">Management &gt; Users</emphasis> page in Kibana or the
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-api-change-password.html">Change Password API</ulink>. These methods are
more complex. You must supply the <literal>elastic</literal> user and its bootstrap password to
log into Kibana or run the API. This requirement means that you cannot use the
default bootstrap password that is derived from the <literal>keystore.seed</literal> setting.
Instead, you must explicitly set a <literal>bootstrap.password</literal> setting in the keystore
before you start Elasticsearch. For example, the following command prompts you to enter a
new bootstrap password:</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/elasticsearch-keystore add "bootstrap.password"</programlisting>
<simpara>You can then start Elasticsearch and Kibana and use the <literal>elastic</literal> user and bootstrap
password to log into Kibana and change the passwords. Alternatively, you can
submit Change Password API requests for each built-in user. These methods are
better suited for changing your passwords after the initial setup is complete,
since at that point the bootstrap password is no longer required.</simpara>
<bridgehead id="add-built-in-user-passwords" renderas="sect3">Adding Built-in User Passwords To Kibana, Logstash, and Beats<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></bridgehead>
<simpara>After the <literal>kibana</literal> user password is set, you need to update the Kibana server
with the new password by setting <literal>elasticsearch.password</literal> in the <literal>kibana.yml</literal>
configuration file:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">elasticsearch.password: kibanapassword</programlisting>
<simpara>The <literal>logstash_system</literal> user is used internally within Logstash when
monitoring is enabled for Logstash.</simpara>
<simpara>To enable this feature in Logstash, you need to update the Logstash
configuration with the new password by setting <literal>xpack.monitoring.elasticsearch.password</literal> in
the <literal>logstash.yml</literal> configuration file:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.elasticsearch.password: logstashpassword</programlisting>
<simpara>If you have upgraded from an older version of Elasticsearch,
the <literal>logstash_system</literal> user may have defaulted to <emphasis>disabled</emphasis> for security reasons.
Once the password has been changed, you can enable the user via the following API call:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT _xpack/security/user/logstash_system/_enable</programlisting>
<remark> CONSOLE</remark>
<simpara>The <literal>beats_system</literal> user is used internally within Beats when monitoring is
enabled for Beats.</simpara>
<simpara>To enable this feature in Beats, you need to update the configuration for each
of your beats to reference the correct username and password. For example:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.monitoring.elasticsearch.username: beats_system
xpack.monitoring.elasticsearch.password: beatspassword</programlisting>
<simpara>If you have upgraded from an older version of Elasticsearch, then you may not have set a
password for the <literal>beats_system</literal> user. If this is the case, then you should use
the <emphasis role="strong">Management &gt; Users</emphasis> page in Kibana or the
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-api-change-password.html">Change Password API</ulink> to set a password
for this user.</simpara>
<bridgehead id="disabling-default-password" renderas="sect3">Disabling default password functionality<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></bridgehead>
<important>
<simpara>This setting is deprecated. The elastic user no longer has a default password.
The password must be set before the user can be used.
See <xref linkend="bootstrap-elastic-passwords"/>.</simpara>
</important>
</section>
<section id="internal-users" role="xpack">
<title>Internal users<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>X-Pack security has three <emphasis>internal</emphasis> users (<literal>_system</literal>, <literal>_xpack</literal>, and <literal>_xpack_security</literal>)
that are responsible for the operations that take place inside an Elasticsearch cluster.</simpara>
<simpara>These users are only used by requests that originate from within the cluster.
For this reason, they cannot be used to authenticate against the API and there
is no password to manage or reset.</simpara>
<simpara>From time-to-time you may find a reference to one of these users inside your
logs, including <link linkend="auditing">audit logs</link>.</simpara>
</section>
<section id="realms" role="xpack">
<title>Realms<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>Authentication in X-Pack security is handled by one or more authentication services
called <emphasis>realms</emphasis>. A <emphasis>realm</emphasis> is used to resolve and authenticate users based on
authentication tokens. X-Pack security provides the following built-in realms:</simpara>
<variablelist>
<varlistentry>
<term>
<emphasis>native</emphasis>
</term>
<listitem>
<simpara>
An internal realm where users are stored in a dedicated Elasticsearch index.
This realm supports an authentication token in the form of username and password,
and is available by default when no realms are explicitly configured. The users
are managed via the <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-api-users.html">User Management API</ulink>. See
<xref linkend="native-realm"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>ldap</emphasis>
</term>
<listitem>
<simpara>
A realm that uses an external LDAP server to authenticate the
users. This realm supports an authentication token in the form of username and
password, and requires explicit configuration in order to be used. See
<xref linkend="ldap-realm"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>active_directory</emphasis>
</term>
<listitem>
<simpara>
A realm that uses an external Active Directory Server to authenticate the
users. With this realm, users are authenticated by usernames and passwords.
See <xref linkend="active-directory-realm"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>pki</emphasis>
</term>
<listitem>
<simpara>
A realm that authenticates users using Public Key Infrastructure (PKI). This
realm works in conjunction with SSL/TLS and identifies the users through the
Distinguished Name (DN) of the client&#8217;s X.509 certificates. See <xref linkend="pki-realm"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>file</emphasis>
</term>
<listitem>
<simpara>
An internal realm where users are defined in files stored on each node in the
Elasticsearch cluster. This realm supports an authentication token in the form
of username and password and is always available. See <xref linkend="file-realm"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>saml</emphasis>
</term>
<listitem>
<simpara>
A realm that facilitates authentication using the SAML 2.0 Web SSO protocol.
This realm is designed to support authentication through Kibana and is not
intended for use in the REST API.  See <xref linkend="saml-realm"/>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara>X-Pack security also supports custom realms. If you need to integrate with another
authentication system, you can build a custom realm plugin. For more information,
see <link linkend="custom-realms">Integrating with Other Authentication Systems</link>.</simpara>
<simpara>Realms live within a <emphasis>realm chain</emphasis>. It is essentially a prioritized list of
configured realms (typically of various types). The order of the list determines
the order in which the realms will be consulted. You should make sure each
configured realm has a distinct <literal>order</literal> setting. In the event that two or more
realms have the same <literal>order</literal>, they will be processed in <literal>name</literal> order.
During the authentication process, X-Pack security will consult and try to
authenticate the request one realm at a time.
Once one of the realms successfully authenticates the request, the authentication
is considered to be successful and the authenticated user will be associated
with the request (which will then proceed to the authorization phase). If a realm
cannot authenticate the request, the next in line realm in the chain will be
consulted. If all realms in the chain could not authenticate the request, the
authentication is then considered to be unsuccessful and an authentication error
will be returned (as HTTP status code <literal>401</literal>).</simpara>
<note><simpara>Some systems (e.g. Active Directory) have a temporary lock-out period after
      several successive failed login attempts. If the same username exists in
      multiple realms, unintentional account lockouts are possible. For more
      information, please see <link linkend="trouble-shoot-active-directory">here</link>.</simpara></note>
<simpara>The default realm chain contains the <literal>native</literal> and <literal>file</literal> realms. To explicitly,
configure a realm chain, you specify the chain in <literal>elasticsearch.yml</literal>. When you
configure a realm chain, only the realms you specify are used for authentication.
To use the <literal>native</literal> and <literal>file</literal> realms, you must include them in the chain.</simpara>
<simpara>The following snippet configures a realm chain that includes the <literal>file</literal> and
<literal>native</literal> realms, as well as two LDAP realms and an Active Directory realm.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.authc:
  realms:

    file:
      type: file
      order: 0

    native:
      type: native
      order: 1

    ldap1:
      type: ldap
      order: 2
      enabled: false
      url: 'url_to_ldap1'
      ...

    ldap2:
      type: ldap
      order: 3
      url: 'url_to_ldap2'
      ...

    ad1:
      type: active_directory
      order: 4
      url: 'url_to_ad'</programlisting>
<simpara>As can be seen above, each realm has a unique name that identifies it and each
realm type dictates its own set of required and optional settings. That said,
there are
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-settings.html#ref-realm-settings">settings that are common to all realms</ulink>.</simpara>
<simpara>Realm types can roughly be classified in two categories:</simpara>
<variablelist>
<varlistentry>
<term>
Internal
</term>
<listitem>
<simpara>
Realms that are internal to Elasticsearch and don&#8217;t require any
            communication with external parties. They are fully managed by
            X-Pack security. There can only be a maximum of one configured realm
            per internal realm type. X-Pack security provides two internal realm
            types: <literal>native</literal> and <literal>file</literal>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
External
</term>
<listitem>
<simpara>
Realms that require interaction with parties/components external to
            Elasticsearch, typically, with enterprise grade identity management
            systems. Unlike internal realms, there can be as many external realms
            as one would like - each with its own unique name and configuration.
            X-Pack security provides the following external realm types: <literal>ldap</literal>,
            <literal>active_directory</literal>, <literal>saml</literal>, and <literal>pki</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section id="active-directory-realm" role="xpack">
<title>Active Directory user authentication<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>You can configure X-Pack security to communicate with Active Directory to authenticate
users. To integrate with Active Directory, you configure an <literal>active_directory</literal>
realm and map Active Directory users and groups to X-Pack security roles in the
<link linkend="mapping-roles">role mapping file</link>.</simpara>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/configuring-ad-realm.html">Configuring an Active Directory Realm</ulink>.</simpara>
<simpara>X-Pack security uses LDAP to communicate with Active Directory, so <literal>active_directory</literal>
realms are similar to <link linkend="ldap-realm"><literal>ldap</literal> realms</link>. Like LDAP directories,
Active Directory stores users and groups hierarchically. The directory&#8217;s
hierarchy is built from containers such as the <emphasis>organizational unit</emphasis> (<literal>ou</literal>),
<emphasis>organization</emphasis> (<literal>o</literal>), and <emphasis>domain controller</emphasis> (<literal>dc</literal>).</simpara>
<simpara>The path to an entry is a <emphasis>Distinguished Name</emphasis> (DN) that uniquely identifies a
user or group. User and group names typically have attributes such as a
<emphasis>common name</emphasis> (<literal>cn</literal>) or <emphasis>unique ID</emphasis> (<literal>uid</literal>). A DN is specified as a string, for
example <literal>"cn=admin,dc=example,dc=com"</literal> (white spaces are ignored).</simpara>
<simpara>X-Pack security only supports Active Directory security groups. You cannot map
distribution groups to roles.</simpara>
<note><simpara>When you use Active Directory for authentication, the username entered by
      the user is expected to match the <literal>sAMAccountName</literal> or <literal>userPrincipalName</literal>,
      not the common name.</simpara></note>
<simpara>The Active Directory realm authenticates users using an LDAP bind request. After
authenticating the user, the realm then searches to find the user&#8217;s entry in
Active Directory. Once the user has been found, the Active Directory realm then
retrieves the user&#8217;s group memberships from the <literal>tokenGroups</literal> attribute on the
user&#8217;s entry in Active Directory.</simpara>
<section id="ad-load-balancing">
<title>Load balancing and failover<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>The <literal>load_balance.type</literal> setting can be used at the realm level to configure how
X-Pack security should interact with multiple Active Directory servers. Two modes of
operation are supported: failover and load balancing.</simpara>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-settings.html#load-balancing">Load Balancing and Failover Settings</ulink>.</simpara>
</section>
<section id="ad-settings">
<title>Active Directory realm settings<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-settings.html#ref-ad-settings">Active Directory Realm Settings</ulink>.</simpara>
</section>
<section id="mapping-roles-ad">
<title>Mapping Active Directory users and groups to roles<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/configuring-ad-realm.html">Configuring an Active Directory realm</ulink>.</simpara>
</section>
<section id="ad-user-metadata">
<title>User metadata in Active Directory realms<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>When a user is authenticated via an Active Directory realm, the following
properties are populated in the user&#8217;s <emphasis>metadata</emphasis>:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Field</simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ldap_dn</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The distinguished name of the user.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ldap_groups</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The distinguished name of each of the groups that were
                        resolved for the user (regardless of whether those
                        groups were mapped to a role).</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>This metadata is returned in the
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-api-authenticate.html">authenticate API</ulink> and can be used with
<link linkend="templating-role-query">templated queries</link> in roles.</simpara>
<simpara>Additional metadata can be extracted from the Active Directory server by configuring
the <literal>metadata</literal> setting on the Active Directory realm.</simpara>
</section>
<section id="active-directory-ssl">
<title>Setting up SSL between Elasticsearch and Active Directory<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>See
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/configuring-tls.html#tls-active-directory">Encrypting communications between Elasticsearch and Active Directory</ulink>.</simpara>
</section>
</section>
<section id="file-realm" role="xpack">
<title>File-based user authentication<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>You can manage and authenticate users with the built-in <literal>file</literal> realm.
With the <literal>file</literal> realm, users are defined in local files on each node in the cluster.</simpara>
<important><simpara>As the administrator of the cluster, it is your responsibility to
            ensure the same users are defined on every node in the cluster.
            X-Pack security does not deliver any mechanism to guarantee this.</simpara></important>
<simpara>The <literal>file</literal> realm is primarily supported to serve as a fallback/recovery realm. It
is mostly useful in situations where all users locked themselves out of the system
(no one remembers their username/password). In this type of scenarios, the <literal>file</literal>
realm is your only way out - you can define a new <literal>admin</literal> user in the <literal>file</literal> realm
and use it to log in and reset the credentials of all other users.</simpara>
<important><simpara>When you configure realms in <literal>elasticsearch.yml</literal>, only the
realms you specify are used for authentication. To use the
<literal>file</literal> realm as a fallback, you must include it in the realm chain.</simpara></important>
<simpara>To define users, X-Pack security provides the <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/users-command.html">users</ulink>
command-line tool. This tool enables you to add and remove users, assign user
roles, and manage user passwords.</simpara>
<simpara>For more information, see
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/configuring-file-realm.html">Configuring a file realm</ulink>.</simpara>
</section>
<section id="ldap-realm" role="xpack">
<title>LDAP user authentication<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>You can configure X-Pack security to communicate with a Lightweight Directory Access
Protocol (LDAP) server to authenticate users. To integrate with LDAP, you
configure an <literal>ldap</literal> realm and map LDAP groups to user roles in the
<link linkend="mapping-roles">role mapping file</link>.</simpara>
<simpara>LDAP stores users and groups hierarchically, similar to the way folders are
grouped in a file system. An LDAP directory&#8217;s hierarchy is built from containers
such as the <emphasis>organizational unit</emphasis> (<literal>ou</literal>), <emphasis>organization</emphasis> (<literal>o</literal>), and
<emphasis>domain controller</emphasis> (<literal>dc</literal>).</simpara>
<simpara>The path to an entry is a <emphasis>Distinguished Name</emphasis> (DN) that uniquely identifies a
user or group. User and group names typically have attributes such as a
<emphasis>common name</emphasis> (<literal>cn</literal>) or <emphasis>unique ID</emphasis> (<literal>uid</literal>). A DN is specified as a string,
for example  <literal>"cn=admin,dc=example,dc=com"</literal> (white spaces are ignored).</simpara>
<simpara>The <literal>ldap</literal> realm supports two modes of operation, a user search mode
and a mode with specific templates for user DNs.</simpara>
<section id="ldap-user-search">
<title>User search mode and user DN templates mode<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/configuring-ldap-realm.html">Configuring an LDAP Realm</ulink>.</simpara>
</section>
<section id="ldap-load-balancing">
<title>Load balancing and failover<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>The <literal>load_balance.type</literal> setting can be used at the realm level to configure how
X-Pack security should interact with multiple LDAP servers. X-Pack security supports both
failover and load balancing modes of operation.</simpara>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-settings.html#load-balancing">Load Balancing and Failover Settings</ulink>.</simpara>
</section>
<section id="ldap-settings">
<title>LDAP realm settings<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-settings.html#ref-ldap-settings">LDAP Realm Settings</ulink>.</simpara>
</section>
<section id="mapping-roles-ldap">
<title>Mapping LDAP groups to roles<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>An integral part of a realm authentication process is to resolve the roles
associated with the authenticated user. Roles define the privileges a user has
in the cluster.</simpara>
<simpara>Since with the <literal>ldap</literal> realm the users are managed externally in the LDAP server,
the expectation is that their roles are managed there as well. If fact, LDAP
supports the notion of groups, which often represent user roles for different
systems in the organization.</simpara>
<simpara>The <literal>ldap</literal> realm enables you to map LDAP users to to roles via their LDAP
groups, or other metadata. This role mapping can be configured via the
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-api-role-mapping.html">role-mapping API</ulink>, or by using a file stored
on each node. When a user authenticates with LDAP, the privileges
for that user are the union of all privileges defined by the roles to which
the user is mapped. For more information, see
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/configuring-ldap-realm.html">Configuring an LDAP Realm</ulink>.</simpara>
</section>
<section id="ldap-user-metadata">
<title>User metadata in LDAP realms<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>When a user is authenticated via an LDAP realm, the following properties are
populated in the user&#8217;s <emphasis>metadata</emphasis>:</simpara>
<informaltable
frame="all"
rowsep="1" colsep="1"
>
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Field</simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ldap_dn</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The distinguished name of the user.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ldap_groups</literal></simpara></entry>
<entry align="left" valign="top"><simpara>The distinguished name of each of the groups that were
                        resolved for the user (regardless of whether those
                        groups were mapped to a role).</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<simpara>This metadata is returned in the
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-api-authenticate.html">authenticate API</ulink>, and can be used with
<link linkend="templating-role-query">templated queries</link> in roles.</simpara>
<simpara>Additional fields can be included in the user&#8217;s metadata by  configuring
the <literal>metadata</literal> setting on the LDAP realm. This metadata is available for use
with the <link linkend="mapping-roles-api">role mapping API</link> or in
<link linkend="templating-role-query">templated role queries</link>.</simpara>
</section>
<section id="ldap-ssl">
<title>Setting up SSL Between Elasticsearch and LDAP<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/configuring-tls.html#tls-ldap">Encrypting Communications Between Elasticsearch and LDAP</ulink>.</simpara>
</section>
</section>
<section id="native-realm" role="xpack">
<title>Native user authentication<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>The easiest way to manage and authenticate users is with the internal <literal>native</literal>
realm. You can use the REST APIs or Kibana to add and remove users, assign user roles, and
manage user passwords.</simpara>
<bridgehead id="native-realm-configuration" renderas="sect3">Configuring a native realm<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></bridgehead>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/configuring-native-realm.html">Configuring a native realm</ulink>.</simpara>
<section id="native-settings">
<title>Native realm settings<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-settings.html#ref-native-settings">Native realm settings</ulink>.</simpara>
</section>
<section id="managing-native-users">
<title>Managing native users<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>X-Pack security enables you to easily manage users in Kibana on the
<emphasis role="strong">Management / Security / Users</emphasis> page.</simpara>
<simpara>Alternatively, you can manage users through the <literal>user</literal> API. For more
information and examples, see <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-api-users.html">User management APIs</ulink>.</simpara>
<note id="migrating-from-file"><simpara>To migrate file-based users to the <literal>native</literal> realm, use the
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/migrate-tool.html">migrate tool</ulink>.</simpara></note>
</section>
</section>
<section id="pki-realm" role="xpack">
<title>PKI user authentication<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>You can configure X-Pack security to use Public Key Infrastructure (PKI) certificates
to authenticate users in Elasticsearch. This requires clients to present X.509
certificates.</simpara>
<note><simpara>You cannot use PKI certificates to authenticate users in Kibana.</simpara></note>
<simpara>To use PKI in Elasticsearch, you configure a PKI realm, enable client authentication on
the desired network layers (transport or http), and map the Distinguished Names
(DNs) from the user certificates to X-Pack security roles in the
<link linkend="mapping-roles">role mapping file</link>.</simpara>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/configuring-pki-realm.html">Configuring a PKI realm</ulink>.</simpara>
<section id="pki-settings">
<title>PKI realm settings<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-settings.html#ref-pki-settings">PKI realm settings</ulink>.</simpara>
</section>
</section>
<section id="saml-realm" role="xpack">
<title>SAML authentication<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>X-Pack security supports user authentication using SAML Single Sign On.
X-Pack security provides this support using the Web Browser SSO profile of the SAML
2.0 protocol.</simpara>
<simpara>This protocol is specifically designed to support authentication via an
interactive web browser, so it does not operate as a standard authentication
realm. Instead, X-Pack security provides features in Kibana and Elasticsearch that work
together to enable interactive SAML sessions.</simpara>
<simpara>This means that the SAML realm is not suitable for use by standard REST clients.
If you configure a SAML realm for use in Kibana, you should also configure
another realm, such as the <link linkend="native-realm">native realm</link> in your authentication
chain.</simpara>
<simpara>In order to simplify the process of configuring SAML authentication within the
Elastic Stack, there is a step-by-step guide to
<link linkend="saml-guide">Configuring Elasticsearch and Kibana to use SAML Single-Sign-On</link>.</simpara>
<simpara>The remainder of this document will describe Elasticsearch specific configuration options
for SAML realms.</simpara>
<section id="saml-settings">
<title>SAML realm settings<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-settings.html#ref-saml-settings">SAML Realm Settings</ulink>.</simpara>
</section>
<section id="_saml_realm_signing_settings">
<title>SAML realm signing settings<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-settings.html#ref-saml-signing-settings">SAML Realm Signing Settings</ulink>.</simpara>
</section>
<section id="_saml_realm_encryption_settings">
<title>SAML realm encryption settings<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-settings.html#ref-saml-encryption-settings">SAML Realm Encryption Settings</ulink>.</simpara>
</section>
<section id="_saml_realm_ssl_settings">
<title>SAML realm SSL settings<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authentication">Edit me</ulink></title>
<simpara>See <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-settings.html#ref-saml-ssl-settings">SAML Realm SSL Settings</ulink>.</simpara>
</section>
</section>
<section id="custom-realms" role="xpack">
<title>Integrating with other authentication systems<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/custom-realm.asciidoc">Edit me</ulink></title>
<simpara>If you are using an authentication system that is not supported out-of-the-box
by X-Pack security, you can create a custom realm to interact with it to authenticate
users. You implement a custom realm as an SPI loaded security extension
as part of an ordinary elasticsearch plugin.</simpara>
<section id="implementing-custom-realm">
<title>Implementing a custom realm<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/custom-realm.asciidoc">Edit me</ulink></title>
<simpara>Sample code that illustrates the structure and implementation of a custom realm
is provided in the <ulink url="https://github.com/elastic/shield-custom-realm-example">custom-realm-example</ulink>
repository on GitHub. You can use this code as a starting point for creating your
own realm.</simpara>
<simpara>To create a custom realm, you need to:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Extend <literal>org.elasticsearch.xpack.security.authc.Realm</literal> to communicate with your
  authentication system to authenticate users.
</simpara>
</listitem>
<listitem>
<simpara>
Implement the <literal>org.elasticsearch.xpack.security.authc.Realm.Factory</literal> interface in
  a class that will be used to create the custom realm.
</simpara>
</listitem>
<listitem>
<simpara>
Extend <literal>org.elasticsearch.xpack.security.authc.DefaultAuthenticationFailureHandler</literal> to
  handle authentication failures when using your custom realm.
</simpara>
</listitem>
</orderedlist>
<simpara>To package your custom realm as a plugin:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Implement an extension class for your realm that extends
  <literal>org.elasticsearch.xpack.core.security.SecurityExtension</literal>. There you need to
  override one or more of the following methods:
</simpara>
<programlisting language="java" linenumbering="unnumbered">@Override
public Map&lt;String, Factory&gt; getRealms() {
    ...
}</programlisting>
<simpara>The <literal>getRealms</literal> method is used to provide a map of type names to the <literal>Factory</literal> that
will be used to create the realm.</simpara>
<programlisting language="java" linenumbering="unnumbered">@Override
public AuthenticationFailureHandler getAuthenticationFailureHandler() {
    ...
}</programlisting>
<simpara>The <literal>getAuthenticationFailureHandler</literal> method is used to optionally provide a
custom <literal>AuthenticationFailureHandler</literal>, which will control how X-Pack responds
in certain authentication failure events.</simpara>
<programlisting language="java" linenumbering="unnumbered">@Override
public List&lt;String&gt; getSettingsFilter() {
    ...
}</programlisting>
<simpara>The <literal>Plugin#getSettingsFilter</literal> method returns a list of setting names that should be
filtered from the settings APIs as they may contain sensitive credentials. Note this method is not
part of the <literal>SecurityExtension</literal> interface, it&#8217;s available as part of the elasticsearch plugin main class.</simpara>
</listitem>
<listitem>
<simpara>
Create a build configuration file for the plugin; Gradle is our recommendation.
</simpara>
</listitem>
<listitem>
<simpara>
Create a <literal>META-INF/services/org.elasticsearch.xpack.core.security.SecurityExtension</literal> descriptor file for the
  extension that contains the fully qualified class name of your <literal>org.elasticsearch.xpack.core.security.SecurityExtension</literal> implementation
</simpara>
</listitem>
<listitem>
<simpara>
Bundle all in a single zip file.
</simpara>
</listitem>
</orderedlist>
</section>
<section id="using-custom-realm">
<title>Using a custom realm to authenticate users<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/custom-realm.asciidoc">Edit me</ulink></title>
<simpara>To use a custom realm:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Install the realm extension on each node in the cluster. You run
  <literal>bin/elasticsearch-plugin</literal> with the <literal>install</literal> sub-command and specify the URL
  pointing to the zip file that contains the extension. For example:
</simpara>
<programlisting language="shell" linenumbering="unnumbered">bin/elasticsearch-plugin install file:///&lt;path&gt;/my-realm-1.0.zip</programlisting>
</listitem>
<listitem>
<simpara>
Add a realm configuration of the appropriate realm type to <literal>elasticsearch.yml</literal>
under the <literal>xpack.security.authc.realms</literal> namespace. The options you can set depend
on the settings exposed by the custom realm. At a minimum, you must set the realm
<literal>type</literal> to the type defined by the extension. If you are configuring multiple
realms, you should also explicitly set the  <literal>order</literal> attribute to control the
order in which the realms are consulted during authentication. You should make
sure each configured realm has a distinct <literal>order</literal> setting. In the event that
two or more realms have the same <literal>order</literal>, they will be processed in realm <literal>name</literal> order.
</simpara>
<important><simpara>When you configure realms in <literal>elasticsearch.yml</literal>, only the
realms you specify are used for authentication. If you also want to use the
<literal>native</literal> or <literal>file</literal> realms, you must include them in the realm chain.</simpara></important>
</listitem>
<listitem>
<simpara>
Restart Elasticsearch.
</simpara>
</listitem>
</orderedlist>
</section>
</section>
<section id="anonymous-access" role="xpack">
<title>Enabling anonymous access<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/anonymous-access.asciidoc">Edit me</ulink></title>
<simpara>Incoming requests are considered to be <emphasis>anonymous</emphasis> if no authentication token
can be extracted from the incoming request. By default, anonymous requests are rejected and an authentication error is returned (status code <literal>401</literal>).</simpara>
<simpara>To enable anonymous access, you assign one or more roles to anonymous
users in the <literal>elasticsearch.yml</literal> configuration file. For example, the following
configuration assigns anonymous users <literal>role1</literal> and <literal>role2</literal>:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.authc:
  anonymous:
    username: anonymous_user <co id="CO4-1"/>
    roles: role1, role2 <co id="CO4-2"/>
    authz_exception: true <co id="CO4-3"/></programlisting>
<calloutlist>
<callout arearefs="CO4-1">
<para>
The username/principal of the anonymous user. Defaults to
<literal>_es_anonymous_user</literal> if not specified.
</para>
</callout>
<callout arearefs="CO4-2">
<para>
The roles to associate with the anonymous user. If no roles are specified, anonymous access is disabled&#8212;anonymous requests will be rejected and return an authentication error.
</para>
</callout>
<callout arearefs="CO4-3">
<para>
When <literal>true</literal>, a 403 HTTP status code is returned if the anonymous user
does not have the permissions needed to perform the requested action and the
user will NOT be prompted to provide credentials to access the requested
resource. When <literal>false</literal>, a 401 HTTP status code is returned if the anonymous user
does not have the necessary permissions and the user is prompted for
credentials to access the requested resource. If you are using anonymous access
in combination with HTTP, you might need to set <literal>authz_exception</literal> to <literal>false</literal>
if your client does not support preemptive basic authentication. Defaults to
<literal>true</literal>.
</para>
</callout>
</calloutlist>
</section>
<section id="controlling-user-cache" role="xpack">
<title>Controlling the user cache<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/user-cache.asciidoc">Edit me</ulink></title>
<simpara>User credentials are cached in memory on each node to avoid connecting to a
remote authentication service or hitting the disk for every incoming request.
You can configure characteristics of the user cache with the <literal>cache.ttl</literal>,
<literal>cache.max_users</literal>, and <literal>cache.hash_algo</literal> realm settings.</simpara>
<note><simpara>PKI realms do not cache user credentials but do cache the resolved user
object to avoid unnecessarily needing to perform role mapping on each request.</simpara></note>
<simpara>The cached user credentials are hashed in memory. By default, X-Pack security uses a
salted <literal>sha-256</literal> hash algorithm. You can use a different hashing algorithm by
setting the <literal>cache_hash_algo</literal> setting to any of the following:</simpara>
<table id="cache-hash-algo"
frame="all"
rowsep="1" colsep="1"
>
<title>Cache hash algorithms</title>
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Algorithm</simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Description</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>ssha256</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses a salted <literal>sha-256</literal> algorithm (default).</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>md5</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>MD5</literal> algorithm.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>sha1</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>SHA1</literal> algorithm.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 1024 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt4</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 16 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt5</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 32 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt6</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 64 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt7</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 128 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt8</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 256 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>bcrypt9</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Uses <literal>bcrypt</literal> algorithm with salt generated in 512 rounds.</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><literal>noop</literal>,<literal>clear_text</literal></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara></simpara></entry>
<entry align="left" valign="top"><simpara>Doesn&#8217;t hash the credentials and keeps it in clear text in
                            memory. CAUTION: keeping clear text is considered insecure
                            and can be compromised at the OS level (for example through
                            memory dumps and using <literal>ptrace</literal>).</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<section id="cache-eviction-api">
<title>Evicting users from the cache<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/user-cache.asciidoc">Edit me</ulink></title>
<simpara>X-Pack security exposes a
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-api-clear-cache.html">Clear Cache API</ulink> you can use
to force the eviction of cached users. For example, the following request evicts
all users from the <literal>ad1</literal> realm:</simpara>
<programlisting language="js" linenumbering="unnumbered">$ curl -XPOST 'http://localhost:9200/_xpack/security/realm/ad1/_clear_cache'</programlisting>
<simpara>To clear the cache for multiple realms, specify the realms as a comma-separated
list:</simpara>
<programlisting language="js" linenumbering="unnumbered">$ curl -XPOST 'http://localhost:9200/_xpack/security/realm/ad1,ad2/_clear_cache'</programlisting>
<simpara>You can also evict specific users:</simpara>
<programlisting language="java" linenumbering="unnumbered">$ curl -XPOST 'http://localhost:9200/_xpack/security/realm/ad1/_clear_cache?usernames=rdeniro,alpacino'</programlisting>
</section>
</section>
</chapter>
<chapter id="saml-guide" role="xpack">
<title>Configuring SAML single-sign-on on the Elastic Stack<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>The Elastic Stack supports SAML single-sign-on (SSO) into Kibana, using Elasticsearch as
a backend service. In SAML terminology, the Elastic Stack is operating as a
<emphasis>Service Provider</emphasis>.</simpara>
<simpara>The other component that is needed to enable SAML single-sign-on is the
<emphasis>Identity Provider</emphasis>, which is a service that handles your credentials and
performs that actual authentication of users.</simpara>
<simpara>If you are interested in configuring SSO into Kibana, then you will need to
provide Elasticsearch with information about your <emphasis>Identity Provider</emphasis>, and you will need
to register the Elastic Stack as a known <emphasis>Service Provider</emphasis> within that
Identity Provider.  There are also a few configuration changes that are
required in Kibana to activate the SAML authentication provider.</simpara>
<note><simpara>The SAML support in Kibana is designed on the expectation that it will be
the primary (or sole) authentication method for users of that Kibana instance.
Once you enable SAML authentication in Kibana it will affect all users who try
to login. The <xref linkend="saml-kibana"/> section provides more detail about how this works.</simpara></note>
<section id="saml-guide-idp">
<title>The identity provider<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>The Elastic Stack supports the SAML 2.0 <emphasis>Web Browser SSO</emphasis> and the SAML
2.0 <emphasis>Single Logout</emphasis> profiles and can integrate with any Identity Provider (IdP)
that supports at least the SAML 2.0 <emphasis>Web Browser SSO Profile</emphasis>.
It has been tested with a number of popular IdP implementations.</simpara>
<simpara>This guide assumes that you have an existing IdP and wish to add Kibana as a
Service Provider.</simpara>
<simpara>The Elastic Stack uses a standard SAML <emphasis>metadata</emphasis> document, in XML format that
defines the capabilities and features of your IdP. You should be able to
download or generate such a document within your IdP administration interface.</simpara>
<simpara>Download the IdP metadata document and store it within the <literal>config</literal> directory on
each Elasticsearch node. For the purposes of this guide, we will assume that you are
storing it as <literal>config/saml/idp-metadata.xml</literal>.</simpara>
<simpara>The IdP will have been assigned an identifier (<emphasis>EntityID</emphasis> in SAML terminology)
which is most commonly expressed in <emphasis>Uniform Resource Identifier</emphasis> (URI) form.
Your admin interface may tell you what this is, or you might need to
read the metadata document to find it - look for the <literal>entityID</literal> attribute on the
<literal>EntityDescriptor</literal> element.</simpara>
<simpara>Most IdPs will provide an appropriate metadata file with all the features that
the Elastic Stack requires, and should only require the  configuration steps
described below. For completeness sake, the minimum requirements that the Elastic
Stack has for the IdP&#8217;s metadata are:</simpara>
<itemizedlist>
<listitem>
<simpara>
An <literal>&lt;EntityDescriptor&gt;</literal> with an <literal>entityID</literal> that matches the Elasticsearch
  <link linkend="saml-create-realm">configuration</link>
</simpara>
</listitem>
<listitem>
<simpara>
An <literal>&lt;IDPSSODescriptor&gt;</literal> that supports the SAML 2.0 protocol
  (<literal>urn:oasis:names:tc:SAML:2.0:protocol</literal>).
</simpara>
</listitem>
<listitem>
<simpara>
At least one <literal>&lt;KeyDescriptor&gt;</literal> that is configured for <emphasis>signing</emphasis> (that is, it
  has <literal>use="signing"</literal> or leaves the <literal>use</literal> unspecified)
</simpara>
</listitem>
<listitem>
<simpara>
A <literal>&lt;SingleSignOnService&gt;</literal> with binding of HTTP-Redirect
  (<literal>urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect</literal>)
</simpara>
</listitem>
<listitem>
<simpara>
If you wish to support <link linkend="saml-logout">Single Logout</link>, a <literal>&lt;SingleLogoutService&gt;</literal>
  with binding of HTTP-Redirect
  (<literal>urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect</literal>)
</simpara>
</listitem>
</itemizedlist>
<simpara>The Elastic Stack requires that all messages from the IdP are signed.
For authentication <literal>&lt;Response&gt;</literal> messages, the signature may be applied to either
the response itself, or to the individual assertions.
For <literal>&lt;LogoutRequest&gt;</literal> messages, the message itself must be signed, and the
signature should be provided as a URL parameter, as required by the HTTP-Redirect
binding.</simpara>
</section>
<section id="saml-guide-authentication">
<title>Configure Elasticsearch for SAML authentication<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>There are five configuration steps to enable SAML authentication in Elasticsearch:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Enable SSL/TLS for HTTP
</simpara>
</listitem>
<listitem>
<simpara>
Enable the Token Service
</simpara>
</listitem>
<listitem>
<simpara>
Create one or more SAML realms
</simpara>
</listitem>
<listitem>
<simpara>
Configure role mappings
</simpara>
</listitem>
<listitem>
<simpara>
Generate a SAML Metadata file for use by your Identity Provider <emphasis>(optional)</emphasis>
</simpara>
</listitem>
</orderedlist>
<section id="_enable_tls_for_http">
<title>Enable TLS for HTTP<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>If your Elasticsearch cluster is operating in production mode, then you must
configure the HTTP interface to use SSL/TLS before you can enable SAML
authentication.</simpara>
<simpara>For more information, see
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/configuring-tls.html#tls-http">Encrypting HTTP Client Communications</ulink>.</simpara>
</section>
<section id="_enable_the_token_service">
<title>Enable the token service<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>The Elasticsearch SAML implementation makes use of the Elasticsearch Token Service.  This service
is automatically enabled if you configure TLS on the HTTP interface, and can be
explicitly configured by including the following in your <literal>elasticsearch.yml</literal> file:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.authc.token.enabled: true</programlisting>
</section>
<section id="saml-create-realm">
<title>Create a SAML realm<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>SAML authentication is enabled by configuring a SAML realm within the
authentication chain for Elasticsearch.</simpara>
<simpara>This realm has a few mandatory settings, and a number of optional settings.
The available settings are described in detail in the
<link linkend="saml-settings">SAML realm documentation</link>, this guide will walk you through
the most common settings.</simpara>
<simpara>Create a realm by adding the following to your <literal>elasticsearch.yml</literal>
configuration file. Each configuration value is explained below.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.authc.realms.saml1:
  type: saml
  order: 2
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.example.com/"
  sp.acs: "https://kibana.example.com/api/security/v1/saml"
  sp.logout: "https://kibana.example.com/logout"
  attributes.principal: "urn:oid:0.9.2342.19200300.100.1.1"
  attributes.groups: "urn:oid:1.3.6.1.4.1.5923.1.5.1."</programlisting>
<important><simpara>SAML is used when authenticating via Kibana, but it is not an
effective means of authenticating directly to the Elasticsearch REST API. For this reason
we recommend that you include at least one additional realm such as the
<link linkend="native-realm">native realm</link> in your authentication chain for use by API
clients.</simpara></important>
<simpara>The configuration values used in the example above are:</simpara>
<variablelist>
<varlistentry>
<term>
xpack.security.authc.realms.saml
</term>
<listitem>
<simpara>
    This defines a new authentication realm named "saml1".
    See <xref linkend="realms"/> for more explanation of realms.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
type
</term>
<listitem>
<simpara>
The <literal>type</literal> must be <literal>saml</literal>
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
order
</term>
<listitem>
<simpara>
    You should define a unique order on each realm in your authentication chain.
    It is recommended that the SAML realm be at the bottom of your authentication
    chain (that is, that it has the <emphasis>highest</emphasis> order).
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
idp.metadata.path
</term>
<listitem>
<simpara>
    This is the path to the metadata file that you saved for your Identity Provider.
    The path that you enter here is relative to your <literal>config/</literal> directory.
    X-Pack security will automatically monitor this file for changes and will
    reload the configuration whenever it is updated.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
idp.entity_id
</term>
<listitem>
<simpara>
    This is the identifier (SAML EntityID) that your IdP uses.
    It should match the <literal>entityID</literal> attribute within the metadata file.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
sp.entity_id
</term>
<listitem>
<simpara>
    This is a unique identifier for your Kibana instance, expressed as a URI.
    You will use this value when you add Kibana as a service provider within your IdP.
    We recommend that you use the base URL for your Kibana instance as the entity ID.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
sp.acs
</term>
<listitem>
<simpara>
    The <emphasis>Assertion Consumer Service</emphasis> (ACS) endpoint is the URL within Kibana that accepts
    authentication messages from the IdP.
    This ACS endpoint supports the SAML HTTP-POST binding only.
    It must be a URL that is accessible from the web browser of the user who is
    attempting to login to Kibana, it does not need to be directly accessible by Elasticsearch
    or the IdP.
    The correct value may vary depending on how you have installed Kibana and
    whether there are any proxies involved, but it will typically be
    <literal>${kibana-url}/api/security/v1/saml</literal> where <emphasis>${kibana-url}</emphasis> is the base URL for
    your Kibana instance.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
sp.logout
</term>
<listitem>
<simpara>
    This is the URL within Kibana that accepts logout messages from the IdP.
    Like the <literal>sp.acs</literal> URL, it must be accessible from the web browser, but does
    not need to be directly accessible by Elasticsearch or the IdP. The correct value may
    vary depending on how you have installed Kibana and whether there are any
    proxies involved, but it will typically be <literal>${kibana-url}/logout</literal> where
    <emphasis>${kibana-url}</emphasis> is the base URL for your Kibana instance.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
attribute.principal
</term>
<listitem>
<simpara>
See <xref linkend="saml-attribute-mapping"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
attribute.groups
</term>
<listitem>
<simpara>
See <xref linkend="saml-attribute-mapping"/>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section id="saml-attribute-mapping">
<title>Attribute mapping<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>When a user connects to Kibana through your Identity Provider, the Identity
Provider will supply a SAML Assertion about the user. The assertion will contain
an <emphasis>Authentication Statement</emphasis> indicating that the user has successfully
authenticated to the IdP and one or more <emphasis>Attribute Statements</emphasis> that will
include <emphasis>Attributes</emphasis> for the user.</simpara>
<simpara>These attributes may include such things as:</simpara>
<itemizedlist>
<listitem>
<simpara>
the user&#8217;s username
</simpara>
</listitem>
<listitem>
<simpara>
the user&#8217;s email address
</simpara>
</listitem>
<listitem>
<simpara>
the user&#8217;s groups or roles
</simpara>
</listitem>
</itemizedlist>
<simpara>Attributes in SAML are named using a URI such as
<literal>urn:oid:0.9.2342.19200300.100.1.1</literal> or
<literal>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn</literal>, and have one or
more values associated with them.</simpara>
<simpara>These attribute identifiers vary between IdPs, and most IdPs offer ways to
customise the URIs and their associated value.</simpara>
<simpara>Elasticsearch uses these attributes to infer information about the user who has
logged in, and they can be used for role mapping (below).</simpara>
<simpara>In order for these attributes to be useful, Elasticsearch and the IdP need to have a
common value for the names of the attributes. This is done manually, by
configuring the IdP and the X-Pack security SAML realm to use the same URI name for
each logical user attribute.</simpara>
<simpara>The recommended steps for configuring these SAML attributes are as follows:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>
Consult your IdP to see what user attributes it can provide.
  This varies greatly between providers, but you should be able to obtain a list
  from the documentation, or from your local admin.
</simpara>
</listitem>
<listitem>
<simpara>
Read through the list of <link linkend="saml-user-properties">user properties</link> that Elasticsearch
  supports, and decide which of them are useful to you, and can be provided by
  your IdP. At a <emphasis>minimum</emphasis>, the <literal>principal</literal> attribute is required.
</simpara>
</listitem>
<listitem>
<simpara>
Configure your IdP to "release" those attributes to your Kibana SAML service
  provider.  This process varies by provider - some will provide a user interface
  for this, while others may require that you edit configuration files.
  Usually the IdP (or your local administrator) will have suggestions about what
  URI to use for each attribute. You can simply accept those suggestions, as the
  Elasticsearch service is entirely configurable and does not require that any specific
  URIs are used.
</simpara>
</listitem>
<listitem>
<simpara>
Configure the SAML realm in Elasticsearch to associate the Elasticsearch user properties (see
  <link linkend="saml-user-properties">the listing</link> below), to the URIs that you configured
  in your IdP. In the example above, we have configured the <literal>principal</literal> and
  <literal>groups</literal> attributes.
</simpara>
</listitem>
</orderedlist>
<section id="_special_attribute_names">
<title>Special attribute names<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>In general, Elasticsearch expects that the configured value for an attribute will be a
URI such as <literal>urn:oid:0.9.2342.19200300.100.1.1</literal>, however there are some
additional names that can be used:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>nameid</literal>
</term>
<listitem>
<simpara>
    This uses the SAML <literal>NamedID</literal> value instead of a SAML attribute. SAML
    <literal>NameID</literal> elements are an optional, but frequently provided, field within a
    SAML Assertion that the IdP may use to identify the Subject of that
    Assertion. In some cases the <literal>NameID</literal> will relate to the user&#8217;s login
    identifier (username) wihin the IdP, but in many cases they will be
    internally generated identifiers that have no obvious meaning outside
    of the IdP.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>nameid:persistent</literal>
</term>
<listitem>
<simpara>
    This uses the SAML <literal>NameID</literal> value, but only if the NameID format is
    <literal>urn:oasis:names:tc:SAML:2.0:nameid-format:persistent</literal>.
    A SAML <literal>NameID</literal> element has an optional <literal>Format</literal> attribute that indicates
    the semantics of the provided name.  It is common for IdPs to be configured
    with "transient" NameIDs that present a new identifier for each session.
    Since it is rarely useful to use a transient NameID as part of an attribute
    mapping, the "nameid:persistent" attribute name can be used as a safety
    mechanism that will cause an error if you attempt to map from a <literal>NameID</literal>
    that does not have a persistent value.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>friendlyName</emphasis>
</term>
<listitem>
<simpara>
    A SAML attribute may have a <emphasis>friendlyName</emphasis> in addition to its URI based name.
    For example the attribute with a name of <literal>urn:oid:0.9.2342.19200300.100.1.1</literal>
    might also have a friendlyName of <literal>uid</literal>.
    You may use these friendly names within an attribute mapping, but it is
    recommended that you use the URI based names, as friendlyNames are neither
    standardized or mandatory.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara>The example below configures a realm to use a persistent nameid for the principal,
and the attribute with the friendlyName "roles" for the user&#8217;s groups.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.authc.realms.saml1:
  type: saml
  order: 2
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.example.com/"
  sp.acs: "https://kibana.example.com/api/security/v1/saml"
  attributes.principal: "nameid:persistent"
  attributes.groups: "roles"</programlisting>
</section>
<section id="saml-user-properties">
<title>Elasticsearch user properties<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>The Elasticsearch SAML realm can be configured to map SAML <literal>attributes</literal> to the
following properties on the authenticated user:</simpara>
<variablelist>
<varlistentry>
<term>
principal
</term>
<listitem>
<simpara>
<emphasis>(Required)</emphasis>
    This is the <emphasis>username</emphasis> that will be applied to a user that authenticates
    against this realm.
    The <literal>principal</literal> appears in places such as the Elasticsearch audit logs.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
groups
</term>
<listitem>
<simpara>
<emphasis>(Recommended)</emphasis>
    If you wish to use your IdP&#8217;s concept of groups or roles as the basis for a
    user&#8217;s Elasticsearch privileges, you should map them with this attribute.
    The <literal>groups</literal> are passed directly to your
    <link linkend="saml-role-mapping">role mapping rules</link>
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
name
</term>
<listitem>
<simpara>
<emphasis>(Optional)</emphasis> The user&#8217;s full name.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
mail
</term>
<listitem>
<simpara>
<emphasis>(Optional)</emphasis> The user&#8217;s email address.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
dn
</term>
<listitem>
<simpara>
<emphasis>(Optional)</emphasis> The user&#8217;s X.500 <emphasis>Distinguished Name</emphasis>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section id="_extracting_partial_values_from_saml_attributes">
<title>Extracting partial values from SAML attributes<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>There are some occasions where the IdP&#8217;s attribute may contain more information
than you wish to use within Elasticsearch. A common example of this is one where the
IdP works exclusively with email addresses, but you would like the user&#8217;s
<literal>principal</literal> to use the <emphasis>local-name</emphasis> part of the email address.
For example if their email address was <literal>james.wong@staff.example.com</literal>, then you
would like their principal to simply be <literal>james.wong</literal>.</simpara>
<simpara>This can be achieved using the <literal>attribute_patterns</literal> setting in the Elasticsearch
realm, as demonstrated in the realm configuration below:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.authc.realms.saml1:
  type: saml
  order: 2
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.example.com/"
  sp.acs: "https://kibana.example.com/api/security/v1/saml"
  attributes.principal: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"
  attribute_patterns.principal: "^([^@]+)@staff\\.example\\.com$"</programlisting>
<simpara>In this case, the user&#8217;s <literal>principal</literal> is mapped from an email attribute, but a
regular expression is applied to the value before it is assigned to the user.
If the regular expression matches, then the result of the first group is used as
effective value. If the regular expression does not match then the attribute
mapping fails.</simpara>
<simpara>In this example, the email address must belong to the <literal>staff.example.com</literal> domain,
and then the local-part (anything before the <literal>@</literal>) is used as the principal.
Any users who try to login using a different email domain will fail because the
regular expression will not match against their email address, and thus their
principal attribute - which is mandatory - will not be populated.</simpara>
<important><simpara>Small mistakes in these regular expressions can have significant
security consequences. For example, if we accidentally left off the trailing
<literal>$</literal> from the example above, then we would match any email address where the
domain starts with <literal>staff.example.com</literal>, and this would accept an email
address such as <literal>admin@staff.example.com.attacker.net</literal>. It is important that
you make sure your regular expressions are as precise as possible so that
you do not inadvertently open an avenue for user impersonation attacks.</simpara></important>
</section>
</section>
<section id="saml-logout">
<title>SAML logout<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>The SAML protocol supports the concept of Single Logout (SLO).
The level of support for SLO varies between Identity Providers.
You should consult the documentation for your IdP to determine what Logout
services it offers.</simpara>
<simpara>By default the Elastic Stack will support SAML SLO if the following are true:</simpara>
<itemizedlist>
<listitem>
<simpara>
Your IdP metadata specifies that the IdP offers a SLO service
</simpara>
</listitem>
<listitem>
<simpara>
You configure <literal>sp.logout</literal>
</simpara>
</listitem>
<listitem>
<simpara>
The setting <literal>idp.use_single_logout</literal> is not <literal>false</literal>
</simpara>
</listitem>
</itemizedlist>
<section id="_idp_slo_service">
<title>IdP SLO service<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>One of the values that Elasticsearch reads from the IdP&#8217;s SAML metadata is the
<literal>&lt;SingleLogoutService&gt;</literal>. In order for Single Logout to work with the Elastic
stack, Elasticsearch requires that this exist and support a binding of
<literal>urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect</literal>.</simpara>
<simpara>The Elastic Stack will send both <literal>&lt;LogoutRequest&gt;</literal> and <literal>&lt;LogoutResponse&gt;</literal>
messages to this service as appropriate.</simpara>
</section>
<section id="_the_sp_logout_setting">
<title>The sp.logout setting<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>The Elasticsearch realm setting <literal>sp.logout</literal> specifies a URL in Kibana to which the IdP can
send both <literal>&lt;LogoutRequest&gt;</literal> and <literal>&lt;LogoutResponse&gt;</literal> messages. This service uses
the SAML HTTP-Redirect binding.</simpara>
<simpara>Elasticsearch will process <literal>&lt;LogoutRequest&gt;</literal> messages, and perform a global signout that
invalidates any existing Elasticsearch security tokens that are associated with the
provided SAML session.</simpara>
<simpara>If you do not configure a value for <literal>sp.logout</literal>, Elasticsearch will refuse all
<literal>&lt;LogoutRequest&gt;</literal> messages.</simpara>
<note><simpara>It is common for IdPs to require that <literal>LogoutRequest</literal> messages be signed,
so you may need to configure <link linkend="saml-enc-sign">signing credentials</link>.</simpara></note>
</section>
<section id="_the_idp_use_single_logout_setting">
<title>The idp.use_single_logout setting<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>If your IdP provides a <literal>&lt;SingleLogoutService&gt;</literal> but you do not wish to use it,
you can configure <literal>idp.use_single_logout: false</literal> in your SAML realm, and Elasticsearch
will ignore the SLO service that your IdP provides. In this case, when a user
logs out of Kibana it will invalidate their Elasticsearch session (security token), but
will not perform any logout at the IdP.</simpara>
</section>
<section id="_using_kibana_without_single_logout">
<title>Using Kibana without single logout<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>If your IdP does not support Single Logout, or you choose not to use it, then
Kibana will perform a "local logout" only.</simpara>
<simpara>This means that Kibana will invalidate the session token it is using to
communicate with Elasticsearch, but will not be able to perform any sort of invalidation
of the Identity Provider session. In most cases this will mean that Kibana users
are still considered to be logged in to the IdP. Consequently, if the user
navigates to the Kibana landing page, they will be automatically reauthenticated,
and will commence a new Kibana session without needing to enter any credentials.</simpara>
<simpara>The possible solutions to this problem are:</simpara>
<itemizedlist>
<listitem>
<simpara>
Ask your IdP administrator or vendor to provide a Single Logout service
</simpara>
</listitem>
<listitem>
<simpara>
If your Idp does provide a Single Logout Service, make sure it is included in
  the IdP metadata file, and do <emphasis>not</emphasis> set <literal>idp.use_single_logout</literal> to <literal>false</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
Advise your users to close their browser after logging out of Kibana
</simpara>
</listitem>
<listitem>
<simpara>
Enable the <literal>force_authn</literal> setting on your SAML realm. This setting causes the
  Elastic Stack to request fresh authentication from the IdP every time a user
  attempts to log into Kibana.
  This setting defaults to <literal>false</literal> because it can be a more cumbersome user
  experience, but it can also be an effective protection to stop users
  piggy-backing on existing IdP sessions.
</simpara>
</listitem>
</itemizedlist>
</section>
</section>
<section id="saml-enc-sign">
<title>Encryption and signing<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>The Elastic Stack supports generating signed SAML messages (for authentication
and/or logout), verifying signed SAML messages from the IdP (for both
authentication and logout) and can process encrypted content.</simpara>
<simpara>You can configure Elasticsearch for signing, encryption or both, with the same
or separate keys used for each of those.</simpara>
<simpara>The Elastic Stack uses X.509 certificates with RSA private keys for SAML
cryptography. These keys can be generated using any standard SSL tool, including
the <literal>elasticsearch-certutil</literal> tool that ships with X-Pack.</simpara>
<simpara>Your IdP may require that the Elastic Stack have a cryptographic key for signing
SAML messages, and that you provide the corresponding signing certificate within
the Service Provider configuration (either within the Elastic Stack SAML
metadata file or manually configured within the IdP administration interface).
While most IdPs do not expected authentication requests to be signed, it is
commonly the case that signatures are required for logout requests. Your IdP
will validate these signatures against the signing certificate that has been
configured for the Elastic Stack Service Provider.</simpara>
<simpara>Encryption certificates are rarely needed, but the Elastic Stack supports them
for cases where IdPs or local policies mandate their use.</simpara>
<section id="_generating_certificates_and_keys">
<title>Generating certificates and keys<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>Elasticsearch supports certificates and keys in either PEM, PKCS#12 or JKS format.
Some Identity Providers are more restrictive in the formats they support, and
will require you to provide the certificates as a file in a particular format.
You should consult the documentation for your IdP to determine what formats they
support. Since PEM format is the most commonly supported format, the examples
below will generate certificates in that format.</simpara>
<simpara>Using the <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/certutil.html"><literal>elasticsearch-certutil</literal></ulink> tool, you can generate a
signing certificate with the following command:</simpara>
<programlisting language="sh" linenumbering="unnumbered">bin/elasticsearch-certutil cert -pem -days 1100 -name saml-sign -out saml-sign.zip</programlisting>
<simpara>This will</simpara>
<itemizedlist>
<listitem>
<simpara>
generate a certificate and key pair (the <literal>cert</literal> subcommand)
</simpara>
</listitem>
<listitem>
<simpara>
create the files in PEM format (<literal>-pem</literal> option)
</simpara>
</listitem>
<listitem>
<simpara>
generate a certificate that is valid for 3 years (<literal>-days 1100</literal>)
</simpara>
</listitem>
<listitem>
<simpara>
name the certificate <literal>saml-sign</literal> (<literal>-name</literal> option)
</simpara>
</listitem>
<listitem>
<simpara>
save the certificate and key in the <literal>saml-sign.zip</literal> file (<literal>-out</literal> option)
</simpara>
</listitem>
</itemizedlist>
<simpara>The generated zip archive will contain 3 files:</simpara>
<itemizedlist>
<listitem>
<simpara>
<literal>saml-sign.crt</literal>, the public certificate to be used for signing
</simpara>
</listitem>
<listitem>
<simpara>
<literal>saml-sign.key</literal>, the private key for the certificate
</simpara>
</listitem>
<listitem>
<simpara>
<literal>ca.crt</literal>, a CA certificate that is not need, and can be ignored.
</simpara>
</listitem>
</itemizedlist>
<simpara>Encryption certificates can be generated with the same process.</simpara>
</section>
<section id="_configuring_elasticsearch_for_signing">
<title>Configuring Elasticsearch for signing<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>By default, X-Pack security will sign <emphasis>all</emphasis> outgoing SAML messages if a signing
key has been configured.</simpara>
<simpara>If you wish to use <emphasis role="strong">PEM formatted</emphasis> keys and certificates for signing, then
you should configure the following settings on the SAML realm:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>signing.certificate</literal>
</term>
<listitem>
<simpara>
The path to the PEM formatted certificate file. e.g. <literal>saml/saml-sign.crt</literal>
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>signing.key</literal>
</term>
<listitem>
<simpara>
The path to the PEM formatted key file. e.g. <literal>saml/saml-sign.key</literal>
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>signing.secure_key_passphrase</literal>
</term>
<listitem>
<simpara>
The passphrase for the key, if the file is encypted. This is a
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/secure-settings.html">secure setting</ulink> that must be set with the
<literal>elasticsearch-keystore</literal> tool.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara>If you wish to use <emphasis role="strong">PKCS#12 formatted</emphasis> files or a <emphasis role="strong">Java Keystore</emphasis> for
signing, then you should configure the following settings on the SAML realm:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>signing.keystore.path</literal>
</term>
<listitem>
<simpara>
The path to the PKCS#12 or JKS keystore. e.g. <literal>saml/saml-sign.p12</literal>
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>signing.keystore.alias</literal>
</term>
<listitem>
<simpara>
The alias of the key within the keystore. e.g. <literal>signing-key</literal>
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>signing.keystore.secure_password</literal>
</term>
<listitem>
<simpara>
The passphrase for the keystore, if the file is encypted. This is a
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/secure-settings.html">secure setting</ulink> that must be set with the
<literal>elasticsearch-keystore</literal> tool.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara>If you wish to sign some, but not all outgoing <emphasis role="strong">SAML messages</emphasis>, then you
should configure the following setting on the SAML realm:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>signing.saml_messages</literal>
</term>
<listitem>
<simpara>
A list of message types to sign. A message type is identified by the
<emphasis>local name</emphasis> of the XML element used for the message. Supported values
are: <literal>AuthnRequest</literal>, <literal>LogoutRequest</literal> and <literal>LogoutResponse</literal>.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section id="_configuring_elasticsearch_for_encrypted_messages">
<title>Configuring Elasticsearch for encrypted messages<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>X-Pack security supports a single key for message decryption. If a key is
configured, then X-Pack security will attempt to use it to decrypt
<literal>EncryptedAssertion</literal> and <literal>EncryptedAttribute</literal> elements in Authentication
responses, and <literal>EncryptedID</literal> elements in Logout requests.</simpara>
<simpara>X-Pack security will reject any SAML message that contains an <literal>EncryptedAssertion</literal>
that cannot be decrypted.</simpara>
<simpara>If an <literal>Assertion</literal> contains both encrypted and plain-text attributes, then
failure to decrypt the encrypted attributes will not cause an automatic
rejection. Rather, X-Pack security will process the available plain-text attributes
(and any <literal>EncryptedAttributes</literal> that could be decrypted).</simpara>
<simpara>If you wish to use <emphasis role="strong">PEM formatted</emphasis> keys and certificates for SAML encryption,
then you should configure the following settings on the SAML realm:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>encryption.certificate</literal>
</term>
<listitem>
<simpara>
The path to the PEM formatted certificate file. e.g. <literal>saml/saml-crypt.crt</literal>
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>encryption.key</literal>
</term>
<listitem>
<simpara>
The path to the PEM formatted key file. e.g. <literal>saml/saml-crypt.key</literal>
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>encryption.secure_key_passphrase</literal>
</term>
<listitem>
<simpara>
The passphrase for the key, if the file is encypted. This is a
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/secure-settings.html">secure setting</ulink> that must be set with the
<literal>elasticsearch-keystore</literal> tool.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara>If you wish to use <emphasis role="strong">PKCS#12 formatted</emphasis> files or a <emphasis role="strong">Java Keystore</emphasis> for SAML
encryption, then you should configure the following settings on the SAML realm:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>encryption.keystore.path</literal>
</term>
<listitem>
<simpara>
The path to the PKCS#12 or JKS keystore. e.g. <literal>saml/saml-crypt.p12</literal>
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>encryption.keystore.alias</literal>
</term>
<listitem>
<simpara>
The alias of the key within the keystore. e.g. <literal>encryption-key</literal>
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>encryption.keystore.secure_password</literal>
</term>
<listitem>
<simpara>
The passphrase for the keystore, if the file is encypted. This is a
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/secure-settings.html">secure setting</ulink> that must be set with the
<literal>elasticsearch-keystore</literal> tool.
</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
</section>
</section>
<section id="_generating_sp_metadata">
<title>Generating SP metadata<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>Some Identity Providers support importing a metadata file from the Service
Provider. This will automatically configure many of the integration options
between the IdP and the SP.</simpara>
<simpara>The Elastic Stack supports generating such a metadata file using the
<literal>bin/elasticsearch-saml-metadata</literal> command in your Elasticsearch directory.</simpara>
<simpara>The <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/saml-metadata.html">documentation for the elasticsearch-saml-metadata utility</ulink>
describes how to run it, and the available command line options.</simpara>
</section>
<section id="saml-role-mapping">
<title>Configuring role mappings<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>When a user authenticates using SAML, they are identified to the Elastic Stack,
but this does not automatically grant them access to perform any actions or
access any data.</simpara>
<simpara>Your SAML users cannot do anything until they are mapped to X-Pack Security
roles. This mapping is performed through the
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-api-role-mapping.html">role-mapping API</ulink></simpara>
<simpara>This is an example of a simple role mapping that grants the <literal>kibana_user</literal> role
to any user who authenticates against the <literal>saml1</literal> realm:</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT /_xpack/security/role_mapping/saml-kibana
{
  "roles": [ "kibana_user" ],
  "enabled": true,
  "rules": {
    "field": { "realm.name": "saml1" }
  }
}</programlisting>
<remark> CONSOLE</remark>
<remark> TEST</remark>
<simpara>The attributes that are mapped via the realm configuration are used to process
role mapping rules, and these rules determine which roles a user is granted.</simpara>
<simpara>The user fields that are provided to the role
mapping are derived from the SAML attributes as follows:</simpara>
<itemizedlist>
<listitem>
<simpara>
<literal>username</literal>: The <literal>principal</literal> attribute
</simpara>
</listitem>
<listitem>
<simpara>
<literal>dn</literal>: The <literal>dn</literal> attribute
</simpara>
</listitem>
<listitem>
<simpara>
<literal>groups</literal>: The <literal>groups</literal> attribute
</simpara>
</listitem>
<listitem>
<simpara>
<literal>metadata</literal>: See <xref linkend="saml-user-metadata"/>
</simpara>
</listitem>
</itemizedlist>
<simpara>For more information, see <xref linkend="mapping-roles"/> and
<ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-api-role-mapping.html">Role Mapping APIs</ulink>.</simpara>
<simpara>If your IdP has the ability to provide groups or roles to Service Providers,
then you should map this SAML attribute to the <literal>attributes.groups</literal> setting in
the Elasticsearch realm, and then make use of it in a role mapping as per the example
below.</simpara>
<simpara>This mapping grants the Elasticsearch <literal>finance_data</literal> role, to any users who authenticate
via the <literal>saml1</literal> realm with the <literal>finance-team</literal> group.</simpara>
<programlisting language="js" linenumbering="unnumbered">PUT /_xpack/security/role_mapping/saml-finance
{
  "roles": [ "finance_data" ],
  "enabled": true,
  "rules": { "all": [
        { "field": { "realm.name": "saml1" } },
        { "field": { "groups": "finance-team" } }
  ] }
}</programlisting>
<remark> CONSOLE</remark>
<remark> TEST</remark>
</section>
<section id="saml-user-metadata">
<title>User metadata<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>By default users who authenticate via SAML will have some additional metadata
fields.</simpara>
<itemizedlist>
<listitem>
<simpara>
<literal>saml_nameid</literal> will be set to the value of the <literal>NameID</literal> element in the SAML
  authentication response
</simpara>
</listitem>
<listitem>
<simpara>
<literal>saml_nameid_format</literal> will be set to the full URI of the NameID&#8217;s <literal>format</literal>
  attribute
</simpara>
</listitem>
<listitem>
<simpara>
Every SAML Attribute that is provided in the authentication response
  (regardless of whether it is mapped to an Elasticsearch user property), will be added
  as the metadata field <literal>saml(name)</literal> where "name" is the full URI name of the
  attribute. For example <literal>saml(urn:oid:0.9.2342.19200300.100.1.3)</literal>.
</simpara>
</listitem>
<listitem>
<simpara>
For every SAML Attribute that has a <emphasis>friendlyName</emphasis>, will also be added as the
  metadata field <literal>saml_friendlyName</literal> where "name" is the full URI name of the
  attribute. For example <literal>saml_mail</literal>.
</simpara>
</listitem>
</itemizedlist>
<simpara>This behaviour can be disabled by adding <literal>populate_user_metadata: false</literal> to as
a setting in the saml realm.</simpara>
</section>
<section id="saml-kibana">
<title>Configuring Kibana<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>SAML authentication in Kibana requires a small number of additional settings
in addition to the standard Kibana security configuration. The
<ulink url="https://www.elastic.co/guide/en/kibana/6.3/using-kibana-with-security.html">Kibana security documentation</ulink>
provides details on the available configuration options that you can apply.</simpara>
<simpara>In particular, since your Elasticsearch nodes have been configured to use TLS on the HTTP
interface, you must configure Kibana to use a <literal>https</literal> URL to connect to Elasticsearch, and
you may need to configure <literal>elasticsearch.ssl.certificateAuthorities</literal> to trust
the certificates that Elasticsearch has been configured to use.</simpara>
<simpara>SAML authentication in Kibana is also subject to the
<literal>xpack.security.sessionTimeout</literal> setting that is described in the Kibana security
documentation, and you may wish to adjst this timeout to meet your local needs.</simpara>
<simpara>The two additional settings that are required for SAML support are shown below:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.authProviders: [saml]
server.xsrf.whitelist: [/api/security/v1/saml]</programlisting>
<simpara>The configuration values used in the example above are:</simpara>
<variablelist>
<varlistentry>
<term>
<literal>xpack.security.authProviders</literal>
</term>
<listitem>
<simpara>
Set this to <literal>[ saml ]</literal> to instruct Kibana to use SAML SSO as the authentication
method.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>server.xsrf.whitelist</literal>
</term>
<listitem>
<simpara>
Kibana has in-built protection against <emphasis>Cross Site Request Forgery</emphasis> attacks which
are designed to prevent the Kibana server from processing requests that
originated from outside the Kibana application.
In order to support SAML authentication messages that originate from your
Identity Provider, we need to explicitly <emphasis>whitelist</emphasis> the SAML authentication URL
within Kibana, so that the Kibana server will not reject these external messages.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara>If your Kibana instance is behind a proxy, you may also need to add configuration
to tell Kibana how to form its public URL. This is needed because all SAML
messages are exchanged via the user&#8217;s web browser, so Kibana needs to know what
URLs are used within the browser. In this case, the following settings should be
added to your <literal>kibana.yml</literal> configuration file:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.public:
  protocol: https
  hostname: kibana.proxy.com
  port: 443</programlisting>
<variablelist>
<varlistentry>
<term>
<literal>xpack.security.public.protocol</literal>
</term>
<listitem>
<simpara>
This is the protocol that the user&#8217;s web browser uses to connect to the proxy.
Must be one of <literal>http</literal> or <literal>https</literal>. It is strongly recommended that you use the
<literal>https</literal> protocol for all access to Kibana.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.public.hostname</literal>
</term>
<listitem>
<simpara>
The fully qualified hostname that your users use to connect to the proxy server.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<literal>xpack.security.public.port</literal>
</term>
<listitem>
<simpara>
The port number that your users use to connect to the proxy server (e.g. <literal>80</literal>
for <literal>http</literal> or <literal>443</literal> for <literal>https</literal>).
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara>These values must be aligned with the URLs used in the Elasticsearch configuration for
<literal>sp.acs</literal> and <literal>sp.logout</literal>.</simpara>
<section id="_supporting_saml_and_basic_authentication_in_kibana">
<title>Supporting SAML and basic authentication in Kibana<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>The SAML support in Kibana is designed on the expectation that it will be the
primary (or sole) authentication method for users of that Kibana instance.
However, it is possible to support both SAML and Basic authentication within a
single Kibana instance by setting <literal>xpack.security.authProviders</literal> as per the
example below:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.authProviders: [saml, basic]</programlisting>
<simpara>The order is important - this will <emphasis>initiate</emphasis> SAML authentication for
unauthenticated users, but will <emphasis>accept</emphasis> basic authentication.</simpara>
<simpara>If Kibana is configured in this way, then users who wish to login with a
username and password, can do so by directly accessing the <literal>/login</literal> page in
Kibana. This login will not use SAML credentials, and will rely on one of the
other security realms within Elasticsearch. Only users who have a username and password
for a configured Elasticsearch authentication realm will be able to login via this page.</simpara>
<simpara>Alternatively, when the <literal>basic</literal> authentication provider is enabled, you can
place a reverse proxy in front of Kibana, and configure it to send a basic
authentication header (<literal>Authorization: Basic ....</literal>) for each request.
If this header is present and valid, Kibana will not initiate the SAML
authentication process.</simpara>
</section>
<section id="_operating_multiple_kibana_instances">
<title>Operating multiple Kibana instances<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authentication/saml-guide.asciidoc">Edit me</ulink></title>
<simpara>If you wish to have multiple Kibana instances that authenticate against the same
Elasticsearch cluster, then each Kibana instance that is configured for SAML authentication,
requires its own SAML realm.</simpara>
<simpara>Each SAML realm must have its own unique Entity ID (<literal>sp.entity_id</literal>), and its own
<emphasis>Assertion Consumer Service</emphasis> (<literal>sp.acs</literal>). Each Kibana instance will be mapped to
the correct realm by looking up the matching <literal>sp.acs</literal> value.</simpara>
<simpara>These realms may use the same Identity Provider, but are not required to.</simpara>
<simpara>The following is example of having 3 difference Kibana instances, 2 of which
use the same internal IdP, and another which uses a different IdP.</simpara>
<programlisting language="yaml" linenumbering="unnumbered">xpack.security.authc.realms.saml_finance:
  type: saml
  order: 2
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.finance.example.com/"
  sp.acs: "https://kibana.finance.example.com/api/security/v1/saml"
  sp.logout: "https://kibana.finance.example.com/logout"
  attributes.principal: "urn:oid:0.9.2342.19200300.100.1.1"
  attributes.groups: "urn:oid:1.3.6.1.4.1.5923.1.5.1."
xpack.security.authc.realms.saml_sales:
  type: saml
  order: 3
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://sso.example.com/"
  sp.entity_id:  "https://kibana.sales.example.com/"
  sp.acs: "https://kibana.sales.example.com/api/security/v1/saml"
  sp.logout: "https://kibana.sales.example.com/logout"
  attributes.principal: "urn:oid:0.9.2342.19200300.100.1.1"
  attributes.groups: "urn:oid:1.3.6.1.4.1.5923.1.5.1."
xpack.security.authc.realms.saml_eng:
  type: saml
  order: 4
  idp.metadata.path: saml/idp-external.xml
  idp.entity_id: "https://engineering.sso.example.net/"
  sp.entity_id:  "https://kibana.engineering.example.com/"
  sp.acs: "https://kibana.engineering.example.com/api/security/v1/saml"
  sp.logout: "https://kibana.engineering.example.com/logout"
  attributes.principal: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn"</programlisting>
<simpara>It is possible to have one or more Kibana instances that use SAML, while other
instances use basic authentication against another realm type (e.g.
<link linkend="native-realm">Native</link> or <link linkend="ldap-realm">LDAP</link>).</simpara>
</section>
</section>
</chapter>
<chapter id="authorization" role="xpack">
<title>User authorization<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authorization/overview.asciidoc">Edit me</ulink></title>
<simpara>X-Pack security introduces the concept of <emphasis>authorization</emphasis> to the Elastic Stack.
Authorization is the process of determining whether the user behind an incoming
request is allowed to execute the request.</simpara>
<simpara>This process takes place after the user is successfully identified and
<link linkend="setting-up-authentication">authenticated</link>.</simpara>
<bridgehead id="roles" renderas="sect2">Role-based access control<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authorization/overview.asciidoc">Edit me</ulink></bridgehead>
<simpara>X-Pack security provides a role-based access control (RBAC) mechanism, which enables
you to authorize users by assigning privileges to roles and assigning roles to
users or groups.</simpara>
<informalfigure>
<mediaobject>
  <imageobject>
  <imagedata fileref="security/authorization/images/authorization.png"/>
  </imageobject>
  <textobject><phrase>This image illustrates role-based access control</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>The authorization process revolves around the following constructs:</simpara>
<variablelist>
<varlistentry>
<term>
<emphasis>Secured Resource</emphasis>
</term>
<listitem>
<simpara>
A resource to which access is restricted. Indices, aliases, documents, fields,
users, and the Elasticsearch cluster itself are all examples of secured objects.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>Privilege</emphasis>
</term>
<listitem>
<simpara>
A named group of one or more actions that a user may execute against a
secured resource. Each secured resource has its own sets of available privileges.
For example, <literal>read</literal> is an index privilege that represents all actions that enable
reading the indexed/stored data. For a complete list of available privileges
see <xref linkend="security-privileges"/>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>Permissions</emphasis>
</term>
<listitem>
<simpara>
A set of one or more privileges against a secured resource. Permissions can
easily be described in words, here are few examples:
</simpara>
<itemizedlist>
<listitem>
<simpara>
<literal>read</literal> privilege on the <literal>products</literal> index
</simpara>
</listitem>
<listitem>
<simpara>
<literal>manage</literal> privilege on the cluster
</simpara>
</listitem>
<listitem>
<simpara>
<literal>run_as</literal> privilege on <literal>john</literal> user
</simpara>
</listitem>
<listitem>
<simpara>
<literal>read</literal> privilege on documents that match query X
</simpara>
</listitem>
<listitem>
<simpara>
<literal>read</literal> privilege on <literal>credit_card</literal> field
</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>Role</emphasis>
</term>
<listitem>
<simpara>
A named set of permissions
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>User</emphasis>
</term>
<listitem>
<simpara>
The authenticated user.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<emphasis>Group</emphasis>
</term>
<listitem>
<simpara>
One or more groups to which a user belongs. Groups are not supported in some
realms, such as native, file, or PKI realms.
</simpara>
</listitem>
</varlistentry>
</variablelist>
<simpara>A role has a unique name and identifies a set of permissions that translate to
privileges on resources. You can associate a user or group with an arbitrary
number of roles. When you map roles to groups, the roles of a user in that group
are the combination of the roles assigned to that group and the roles assigned
to that user. Likewise, the total set of permissions that a user has is defined
by the union of the permissions in all its roles.</simpara>
<simpara>The method for assigning roles to users varies depending on which realms you use
to authenticate users. For more information, see <xref linkend="mapping-roles"/>.</simpara>
<bridgehead id="attributes" renderas="sect2">Attribute-based access control<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authorization/overview.asciidoc">Edit me</ulink></bridgehead>
<simpara>X-Pack security also provides an attribute-based access control (ABAC) mechanism,
which enables you to use attributes to restrict access to documents in search
queries and aggregations. For example, you can assign attributes to users and
documents, then implement an access policy in a role definition. Users with that
role can read a specific document only if they have all the required attributes.</simpara>
<simpara>For more information, see
<ulink url="https://www.elastic.co/blog/attribute-based-access-control-with-xpack">Document-level attribute-based access control with X-Pack 6.1</ulink>.</simpara>
<remark>TO-DO: Add task related to configuring ABAC.</remark>
<section id="built-in-roles" role="xpack">
<title>Built-in roles<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authorization/built-in-roles.asciidoc">Edit me</ulink></title>
<simpara>X-Pack security applies a default role to all users, including
<link linkend="anonymous-access">anonymous users</link>. The default role enables users to access
the authenticate endpoint, change their own passwords, and get information about
themselves.</simpara>
<simpara>X-Pack security also provides a set of built-in roles you can explicitly assign
to users. These roles have a fixed set of privileges and cannot be updated.</simpara>
<variablelist>
<varlistentry>
<term>
<anchor id="built-in-roles-ingest-user" xreflabel="[built-in-roles-ingest-user]"/> <literal>ingest_admin</literal> 
</term>
<listitem>
<simpara>
Grants access to manage <emphasis role="strong">all</emphasis> index templates and <emphasis role="strong">all</emphasis> ingest pipeline configurations.
</simpara>
<note><simpara>This role does <emphasis role="strong">not</emphasis> provide the ability to create indices; those privileges
must be defined in a separate role.</simpara></note>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-kibana-dashboard" xreflabel="[built-in-roles-kibana-dashboard]"/> <literal>kibana_dashboard_only_user</literal> 
</term>
<listitem>
<simpara>
Grants access to the Kibana Dashboard and read-only permissions on the <literal>.kibana</literal>
index. This role does not have access to editing tools in Kibana. For more
information, see
<ulink url="https://www.elastic.co/guide/en/kibana/6.3/xpack-dashboard-only-mode.html">Kibana Dashboard Only Mode</ulink>.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-kibana-system" xreflabel="[built-in-roles-kibana-system]"/> <literal>kibana_system</literal> 
</term>
<listitem>
<simpara>
Grants access necessary for the Kibana system user to read from and write to the
Kibana indices, manage index templates, and check the availability of the Elasticsearch cluster.
This role grants read access to the <literal>.monitoring-*</literal> indices and read and write access
to the <literal>.reporting-*</literal> indices. For more information, see
<ulink url="https://www.elastic.co/guide/en/kibana/6.3/using-kibana-with-security.html">Configuring Security in Kibana</ulink>.
</simpara>
<note><simpara>This role should not be assigned to users as the granted permissions may
change between releases.</simpara></note>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-kibana-user" xreflabel="[built-in-roles-kibana-user]"/> <literal>kibana_user</literal>
</term>
<listitem>
<simpara>
Grants the minimum privileges required for any user of Kibana. This role grants
access to the Kibana indices and grants  monitoring privileges for the cluster.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-logstash-admin" xreflabel="[built-in-roles-logstash-admin]"/> <literal>logstash_admin</literal> 
</term>
<listitem>
<simpara>
Grants access to the <literal>.logstash*</literal> indices for managing configurations.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-logstash-system" xreflabel="[built-in-roles-logstash-system]"/> <literal>logstash_system</literal> 
</term>
<listitem>
<simpara>
Grants access necessary for the Logstash system user to send system-level data
(such as monitoring) to Elasticsearch. For more information, see
<ulink url="http://www.elastic.co/guide/en/logstash/6.3/ls-security.html">Configuring Security in Logstash</ulink>.
</simpara>
<note><simpara>This role should not be assigned to users as the granted permissions may
change between releases.</simpara></note>
<note><simpara>This role does not provide access to the logstash indices and is not
suitable for use within a Logstash pipeline.</simpara></note>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-beats-system" xreflabel="[built-in-roles-beats-system]"/> <literal>beats_system</literal> 
</term>
<listitem>
<simpara>
Grants access necessary for the Beats system user to send system-level data
(such as monitoring) to Elasticsearch.
</simpara>
<note><simpara>This role should not be assigned to users as the granted permissions may
change between releases.</simpara></note>
<note><simpara>This role does not provide access to the beats indices and is not
suitable for writing beats output to Elasticsearch.</simpara></note>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-ml-admin" xreflabel="[built-in-roles-ml-admin]"/> <literal>machine_learning_admin</literal>
</term>
<listitem>
<simpara>
Grants <literal>manage_ml</literal> cluster privileges and read access to the <literal>.ml-*</literal> indices.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-ml-user" xreflabel="[built-in-roles-ml-user]"/> <literal>machine_learning_user</literal>
</term>
<listitem>
<simpara>
Grants the minimum privileges required to view X-Pack machine learning configuration,
status, and results. This role grants <literal>monitor_ml</literal> cluster privileges and
read access to the <literal>.ml-notifications</literal> and <literal>.ml-anomalies*</literal> indices,
which store machine learning results.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-monitoring-user" xreflabel="[built-in-roles-monitoring-user]"/> <literal>monitoring_user</literal>
</term>
<listitem>
<simpara>
Grants the minimum privileges required for any user of X-Pack monitoring other than those
required to use Kibana. This role grants access to the monitoring indices and grants
privileges necessary for reading basic cluster information. Monitoring users should
also be assigned the <literal>kibana_user</literal> role.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-remote-monitoring-agent" xreflabel="[built-in-roles-remote-monitoring-agent]"/> <literal>remote_monitoring_agent</literal>
</term>
<listitem>
<simpara>
Grants the minimum privileges required for a remote monitoring agent to write data
into this cluster.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-reporting-user" xreflabel="[built-in-roles-reporting-user]"/> <literal>reporting_user</literal>
</term>
<listitem>
<simpara>
Grants the specific privileges required for users of X-Pack reporting other than those
required to use Kibana. This role grants access to the reporting indices. Reporting
users should also be assigned the <literal>kibana_user</literal> role and a role that grants them
access to the data that will be used to generate reports with.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-superuser" xreflabel="[built-in-roles-superuser]"/> <literal>superuser</literal>
</term>
<listitem>
<simpara>
Grants full access to the cluster, including all indices and data. A user with
the <literal>superuser</literal> role can also manage users and roles and
<link linkend="run-as-privilege">impersonate</link> any other user in the system. Due to the
permissive nature of this role, take extra care when assigning it to a user.
</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-transport-client" xreflabel="[built-in-roles-transport-client]"/> <literal>transport_client</literal>
</term>
<listitem>
<simpara>
Grants the privileges required to access the cluster through the Java Transport
Client. The Java Transport Client fetches information about the nodes in the
cluster using the <emphasis>Node Liveness API</emphasis> and the <emphasis>Cluster State API</emphasis> (when
sniffing is enabled). Assign your users this role if they use the
Transport Client.
</simpara>
<note><simpara>Using the Transport Client effectively means the users are granted access
to the cluster state. This means users can view the metadata over all indices,
index templates, mappings, node and basically everything about the cluster.
However, this role does not grant permission to view the data in all indices.</simpara></note>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-watcher-admin" xreflabel="[built-in-roles-watcher-admin]"/> <literal>watcher_admin</literal>
</term>
<listitem>
<simpara>Grants write access to the <literal>.watches</literal> index, read access to the watch history and
the triggered watches index and allows to execute all watcher actions.</simpara>
</listitem>
</varlistentry>
<varlistentry>
<term>
<anchor id="built-in-roles-watcher-user" xreflabel="[built-in-roles-watcher-user]"/> <literal>watcher_user</literal>
</term>
<listitem>
<simpara>Grants read access to the <literal>.watches</literal> index, the get watch action and the watcher
stats.</simpara>
</listitem>
</varlistentry>
</variablelist>
</section>
<section id="defining-roles" role="xpack">
<title>Defining roles<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authorization/managing-roles.asciidoc">Edit me</ulink></title>
<simpara>A role is defined by the following JSON structure:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "run_as": [ ... ], <co id="CO5-1"/>
  "cluster": [ ... ], <co id="CO5-2"/>
  "indices": [ ... ] <co id="CO5-3"/>
}</programlisting>
<remark> NOTCONSOLE</remark>
<calloutlist>
<callout arearefs="CO5-1">
<para>
A list of usernames the owners of this role can <link linkend="run-as-privilege">impersonate</link>.
</para>
</callout>
<callout arearefs="CO5-2">
<para>
A list of cluster privileges. These privileges define the
    cluster level actions users with this role are able to execute. This field
    is optional (missing <literal>cluster</literal> privileges effectively mean no cluster level
    permissions).
</para>
</callout>
<callout arearefs="CO5-3">
<para>
A list of indices permissions entries. This field is optional (missing <literal>indices</literal>
    privileges effectively mean no index level permissions).
</para>
</callout>
</calloutlist>
<note id="valid-role-name"><simpara>Role names must be at least 1 and no more than 1024 characters. They can
      contain alphanumeric characters (<literal>a-z</literal>, <literal>A-Z</literal>, <literal>0-9</literal>), spaces,
      punctuation, and printable symbols in the <ulink url="https://en.wikipedia.org/wiki/Basic_Latin_(Unicode_block)">Basic Latin (ASCII) block</ulink>.
      Leading or trailing whitespace is not allowed.</simpara></note>
<simpara>The following describes the structure of an indices permissions entry:</simpara>
<programlisting language="js" linenumbering="unnumbered">{
  "names": [ ... ], <co id="CO6-1"/>
  "privileges": [ ... ], <co id="CO6-2"/>
  "field_security" : { ... }, <co id="CO6-3"/>
  "query": "..." <co id="CO6-4"/>
}</programlisting>
<remark> NOTCONSOLE</remark>
<calloutlist>
<callout arearefs="CO6-1">
<para>
A list of indices (or index name patterns) to which the permissions in this
    entry apply.
</para>
</callout>
<callout arearefs="CO6-2">
<para>
The index level privileges the owners of the role have on the associated
    indices (those indices that are specified in the <literal>name</literal> field)
</para>
</callout>
<callout arearefs="CO6-3">
<para>
Specification for document fields the owners of the role have read access to.
    See <xref linkend="field-and-document-access-control"/> for details.
</para>
</callout>
<callout arearefs="CO6-4">
<para>
A search query that defines the documents the owners of the role have read
    access to. A document within the associated indices must match this query
    in order for it to be accessible by the owners of the role.
</para>
</callout>
</calloutlist>
<tip>
<simpara>When specifying index names, you can use indices and aliases with their full
names or regular expressions that refer to multiple indices.</simpara>
<itemizedlist>
<listitem>
<simpara>
Wildcard (default) - simple wildcard matching where <literal>*</literal> is a placeholder
  for zero or more characters, <literal>?</literal> is a placeholder for a single character
  and <literal>\</literal> may be used as an escape character.
</simpara>
</listitem>
<listitem>
<simpara>
Regular Expressions - A more powerful syntax for matching more complex
  patterns. This regular expression is based on Lucene&#8217;s regexp automaton
  syntax. To enable this syntax, it must be wrapped within a pair of
  forward slashes (<literal>/</literal>). Any pattern starting with <literal>/</literal> and not ending with
  <literal>/</literal> is considered to be malformed.
</simpara>
</listitem>
</itemizedlist>
<formalpara><title>Example Regular Expressions</title><para>
<programlisting language="yaml" linenumbering="unnumbered">"foo-bar":               # match the literal `foo-bar`
"foo-*":                 # match anything beginning with "foo-"
"logstash-201?-*":       # ? matches any one character
"/.*-201[0-9]-.*/":      # use a regex to match anything containing 2010-2019
"/foo":                  # syntax error - missing final /</programlisting>
</para></formalpara>
</tip>
<simpara>The following snippet shows an example definition of a <literal>clicks_admin</literal> role:</simpara>
<programlisting language="js" linenumbering="unnumbered">POST /_xpack/security/role/clicks_admin
{
  "run_as": [ "clicks_watcher_1" ],
  "cluster": [ "monitor" ],
  "indices": [
    {
      "names": [ "events-*" ],
      "privileges": [ "read" ],
      "field_security" : {
        "grant" : [ "category", "@timestamp", "message" ]
      },
      "query": "{\"match\": {\"category\": \"click\"}}"
    }
  ]
}</programlisting>
<remark> CONSOLE</remark>
<simpara>Based on the above definition, users owning the <literal>clicks_admin</literal> role can:</simpara>
<itemizedlist>
<listitem>
<simpara>
Impersonate the <literal>clicks_watcher_1</literal> user and execute requests on its behalf.
</simpara>
</listitem>
<listitem>
<simpara>
Monitor the Elasticsearch cluster
</simpara>
</listitem>
<listitem>
<simpara>
Read data from all indices prefixed with <literal>events-</literal>
</simpara>
</listitem>
<listitem>
<simpara>
Within these indices, only read the events of the <literal>click</literal> category
</simpara>
</listitem>
<listitem>
<simpara>
Within these document, only read the <literal>category</literal>, <literal>@timestamp</literal> and <literal>message</literal>
    fields.
</simpara>
</listitem>
</itemizedlist>
<tip><simpara>For a complete list of available <link linkend="security-privileges">cluster and indices privileges</link></simpara></tip>
<simpara>There are two available mechanisms to define roles: using the <emphasis>Role Management APIs</emphasis>
or in local files on the Elasticsearch nodes.  X-Pack security also supports implementing
custom roles providers.  If you need to integrate with another system to retrieve
user roles, you can build a custom roles provider plugin. For more information,
see <link linkend="custom-roles-provider">Custom Roles Provider Extension</link>.</simpara>
<bridgehead id="roles-management-ui" renderas="sect2">Role management UI<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authorization/managing-roles.asciidoc">Edit me</ulink></bridgehead>
<simpara>X-Pack security enables you to easily manage users and roles from within Kibana. To
manage roles, log in to Kibana and go to <emphasis role="strong">Management / Elasticsearch / Roles</emphasis>.</simpara>
<bridgehead id="roles-management-api" renderas="sect2">Role management API<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authorization/managing-roles.asciidoc">Edit me</ulink></bridgehead>
<simpara>The <emphasis>Role Management APIs</emphasis> enable you to add, update, remove and retrieve roles
dynamically. When you use the APIs to manage roles in the <literal>native</literal> realm, the
roles are stored in an internal Elasticsearch index. For more information and examples,
see <ulink url="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/security-api-roles.html">Role Management APIs</ulink>.</simpara>
<bridgehead id="roles-management-file" renderas="sect2">File-based role management<ulink role="edit_me" url="https://github.com/elastic/elasticsearch/edit/6.3/x-pack/docs/en/security/authorization/managing-roles.asciidoc">Edit me</ulink></bridgehead>
<simpara>Apart from the <emphasis>Role Management APIs</emphasis>, roles can also be defined in local
<literal>roles.yml</literal> file located in <literal>ES_PATH_CONF</literal>. This is a YAML file where each
role definition is keyed by its name.</simpara>
<important>
<simpara>If the same role name is used in the <literal>roles.yml</literal> file and through the
<emphasis>Role Management APIs</emphasis>, the role found in the file will be used.</simpara>
</important>
<simpara>While the <emphasis>Role Management APIs</emphasis> is the preferred mechanism to define roles,
using the <literal>roles.yml</literal> file becomes useful if you want to define fixed roles that
no one (beside an administrator having physical access to the Elasticsearch nodes)
would be able to change.</simpara>
<important>
<simpara>The <literal>roles.yml</literal> file is managed locally by the node and is not globally by the
cluster. This means that with a typical multi-node cluster, the exact same
changes need to be applied on each and every node in the cluster.</simpara>
<simpara>A safer approach would be to apply the change on one of the nodes and have the
<literal>roles.yml</literal> distributed/copied to all other nodes in the cluster (either
manually or using a configuration management system such as Puppet or Chef).</simpara>
</important>
<simpara>The following snippet shows an example of the <literal>roles.yml</literal> file configuration:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">click_admins:
  run_as: [ 'clicks_watcher_1' ]
  cluster: [ 'monitor' ]
  indices:
    - names: [ 'events-*' ]
      privileges: [ 'read' ]
      field_security:
        grant: ['category', '@timestamp', 'message' ]
      query: '{"match": {"category": "click"}}'</programlisting>
<simpara>X-Pack security continuously monitors the <literal>roles.yml</literal> file and automatically picks
up and applies any changes to it.</simpara>
</section>
<section id="security-privileges" role="xpack">
<title>Security privileges<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authorization/privileges.asciidoc">Edit me</ulink></title>
<simpara>This section lists the privileges that you can assign to a role.</simpara>
<section id="privileges-list-cluster">
<title>Cluster privileges<ulink role="edit_me" url="https://github.com/elastic/stack-docs/edit/6.3/docs/en/stack/security/authorization/privileges.asciidoc">Edit me</ulink></title>
<informaltable tabstyle="horizontal" frame="none" colsep="0" rowsep="0"><tgroup cols="2"><colspec colwidth="15*"/><colspec colwidth="85*"/><tbody valign="top">
<row>
<entry>
<simpara>
<literal>all</literal>
</simpara>
</entry>
<entry>
<simpara>
All cluster administration operations, like snapshotting, node shutdown/restart,
settings update, rerouting, or managing users and roles.
</simpara>
</entry>
</row>
<row>
<entry>
<simpara>
<literal>monitor</literal>
</simpara>
